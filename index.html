<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swadist Adda POS - World's Best POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .hidden {
            display: none;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(to right, #9333ea, #3b82f6);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #000000;
            transition: all 0.2s;
        }
        .input:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.2);
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: all 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .gradient-header {
            background: linear-gradient(to right, #9333ea, #3b82f6);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .payment-option {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .payment-option:hover:not(.disabled) {
            border-color: #9333ea;
            background: #f3e8ff;
            transform: scale(1.05);
        }
        .payment-option.selected {
            border-color: #9333ea;
            background: #f3e8ff;
        }
        .payment-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-online {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-cash {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-udhaar {
            background: #fee2e2;
            color: #991b1b;
        }
        .badge-reward {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-ineligible {
            background: #fecaca;
            color: #7f1d1d;
        }
        .badge-supplier {
            background: #d1fae5;
            color: #065f46;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1001;
            display: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .toast.show {
            opacity: 1;
        }
        .page-content {
            min-height: 400px;
        }
        .highlight-reward {
            border-left: 4px solid #10b981;
            background-color: #f0fdf4;
        }
        .highlight-ineligible {
            border-left: 4px solid #ef4444;
            background-color: #fef2f2;
        }
        .marquee-container {
            background: linear-gradient(to right, #fef3c7, #fef7cd);
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .marquee {
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(to right, #9333ea, #3b82f6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s;
        }
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .quick-action {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .quick-action:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .quick-action i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #9333ea;
        }
        .inventory-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .inventory-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .sale-item {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .search-result-item:hover {
            background: #f3f4f6;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .export-card {
            cursor: pointer;
            border: 2px solid #e5e7eb;
        }
        .export-card:hover {
            border-color: #9333ea;
            background: #f3e8ff;
        }
        .pdf-preview {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background: #f9fafb;
            min-height: 200px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-content, #receipt-content * {
                visibility: visible;
            }
            #receipt-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <div id="sync-indicator" class="sync-indicator">
        <i class="fas fa-sync-alt"></i> Syncing...
    </div>
    <div id="toast" class="toast"></div>

    <script>
        // Real-time sync across devices/tabs
        const SYNC_EVENT = 'swadist-adda-sync';
        
        // Database Module
        const DB = {
            name: 'SwadistAddaDB',
            version: 12, // Increased version for new structure
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.name, this.version);
                    
                    request.onerror = () => {
                        console.error('IndexedDB error:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('Database initialized successfully');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (e) => {
                        console.log('Database upgrade needed, version:', e.newVersion);
                        const db = e.target.result;
                        
                        const stores = [
                            'inventory', 'customers', 'sales', 'purchases', 
                            'offers', 'rewards', 'offerProgress', 
                            'udhaarTransactions', 'suppliers', 'settings', 
                            'supplierUdhaarTransactions', 'supplierBalances'
                        ];
                        
                        stores.forEach(storeName => {
                            if (!db.objectStoreNames.contains(storeName)) {
                                console.log('Creating store:', storeName);
                                const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                            }
                        });
                    };
                });
            },

            async add(storeName, data) {
                if (!this.db) {
                    throw new Error('Database not initialized');
                }
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add({
                        ...data,
                        lastModified: Date.now(),
                        deviceId: getDeviceId()
                    });
                    request.onsuccess = () => {
                        resolve(request.result);
                        this.triggerSync(storeName, 'add', request.result);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async update(storeName, data) {
                if (!this.db) {
                    throw new Error('Database not initialized');
                }
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.put({
                        ...data,
                        lastModified: Date.now(),
                        deviceId: getDeviceId()
                    });
                    request.onsuccess = () => {
                        resolve(request.result);
                        this.triggerSync(storeName, 'update', data.id);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async delete(storeName, id) {
                if (!this.db) {
                    throw new Error('Database not initialized');
                }
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => {
                        resolve();
                        this.triggerSync(storeName, 'delete', id);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async getAll(storeName) {
                if (!this.db) {
                    throw new Error('Database not initialized');
                }
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            },

            async getMaxId(storeName) {
                if (!this.db) {
                    throw new Error('Database not initialized');
                }
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.openCursor(null, 'prev');
                    request.onsuccess = (e) => {
                        const cursor = e.target.result;
                        resolve(cursor ? cursor.value.id : 0);
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            triggerSync(storeName, action, id) {
                const syncEvent = new CustomEvent(SYNC_EVENT, {
                    detail: { storeName, action, id, timestamp: Date.now() }
                });
                window.dispatchEvent(syncEvent);
                
                const syncData = {
                    storeName,
                    action,
                    id,
                    timestamp: Date.now(),
                    deviceId: getDeviceId()
                };
                localStorage.setItem('lastSync', JSON.stringify(syncData));
            },

            async handleExternalChange(storeName, action, id) {
                showSyncIndicator();
                await loadData();
                render();
                setTimeout(hideSyncIndicator, 1000);
            }
        };

        // Device ID for multi-device tracking
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Sync indicator functions
        function showSyncIndicator() {
            const indicator = document.getElementById('sync-indicator');
            if (indicator) indicator.style.display = 'block';
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('sync-indicator');
            if (indicator) indicator.style.display = 'none';
        }

        // Toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }
        }

        // App State
        let state = {
            currentPage: 'dashboard',
            inventory: [],
            customers: [],
            sales: [],
            purchases: [],
            offers: [],
            rewards: [],
            offerProgress: [],
            udhaarTransactions: [],
            suppliers: [],
            supplierUdhaarTransactions: [],
            supplierBalances: [],
            cart: [],
            selectedCustomer: null, 
            selectedPaymentMode: 'Cash',
            saleDate: new Date().toISOString().split('T')[0],
            salesFilterFromDate: new Date().toISOString().split('T')[0],
            salesFilterToDate: new Date().toISOString().split('T')[0],
            isLoading: false,
            settings: {
                businessName: 'Swadist Adda',
                currency: 'â‚¹',
                taxRate: 0,
                printReceipts: true
            }
        };

        // Initialize App
        async function initApp() {
            try {
                console.log('Initializing Swadist Adda POS...');
                await DB.init();
                console.log('Database initialized');
                await loadData();
                
                // Load settings
                const savedSettings = await DB.getAll('settings');
                if (savedSettings.length > 0) {
                    state.settings = { ...state.settings, ...savedSettings[0] };
                }
                
                // Ensure render happens after all data is loaded
                setTimeout(() => {
                    render();
                    
                    // Setup cross-tab synchronization
                    window.addEventListener(SYNC_EVENT, (e) => {
                        const { storeName, action, id } = e.detail;
                        DB.handleExternalChange(storeName, action, id);
                    });
                    
                    // Listen for localStorage changes (other tabs)
                    window.addEventListener('storage', (e) => {
                        if (e.key === 'lastSync' && e.newValue) {
                            const syncData = JSON.parse(e.newValue);
                            if (syncData.deviceId !== getDeviceId()) {
                                DB.handleExternalChange(syncData.storeName, syncData.action, syncData.id);
                            }
                        }
                    });
                    
                    // Auto-refresh data every 5 seconds for multi-user support
                    setInterval(async () => {
                        await loadData();
                        if (state.currentPage === 'udhaar') {
                            changePage('udhaar');
                        }
                    }, 5000);
                    
                    // Show welcome message
                    setTimeout(() => {
                        showToast('ðŸš€ Welcome to Swadist Adda POS - World\'s Best POS System!');
                    }, 1000);
                }, 100);
                
            } catch (error) {
                console.error('Init error:', error);
                showToast('Failed to initialize app: ' + error.message, 5000);
            }
        }

        // Add this function to validate and fix sales data
        async function validateSalesData() {
            try {
                const sales = await DB.getAll('sales');
                let fixedCount = 0;
                
                for (const sale of sales) {
                    // Ensure sale has required fields
                    if (!sale.items || !Array.isArray(sale.items)) {
                        sale.items = [];
                        await DB.update('sales', sale);
                        fixedCount++;
                    }
                    
                    // Ensure customer exists
                    if (sale.customerId) {
                        const customer = state.customers.find(c => c.id === sale.customerId);
                        if (!customer) {
                            // Assign to Walk-In customer if original customer doesn't exist
                            const walkIn = state.customers.find(c => c.name === 'Walk-In');
                            if (walkIn) {
                                sale.customerId = walkIn.id;
                                sale.customerName = 'Walk-In';
                                await DB.update('sales', sale);
                                fixedCount++;
                            }
                        }
                    }
                }
                
                if (fixedCount > 0) {
                    console.log(`Fixed ${fixedCount} sales records`);
                    await loadData();
                }
            } catch (error) {
                console.error('Error validating sales data:', error);
            }
        }

        async function loadData() {
            state.isLoading = true;
            try {
                state.inventory = await DB.getAll('inventory');
                state.customers = await DB.getAll('customers');
                state.sales = await DB.getAll('sales');
                state.purchases = await DB.getAll('purchases');
                state.offers = await DB.getAll('offers');
                state.rewards = await DB.getAll('rewards');
                state.offerProgress = await DB.getAll('offerProgress');
                state.udhaarTransactions = await DB.getAll('udhaarTransactions');
                state.suppliers = await DB.getAll('suppliers');
                state.supplierUdhaarTransactions = await DB.getAll('supplierUdhaarTransactions');
                state.supplierBalances = await DB.getAll('supplierBalances');
                
                // Validate data integrity
                await validateSalesData();
                
                // Create default Walk-In customer if not exists
                if (!state.customers.find(c => c.name === 'Walk-In')) {
                    await DB.add('customers', {
                        name: 'Walk-In',
                        mobile: '',
                        udhaar: 0,
                        createdAt: new Date().toISOString()
                    });
                    state.customers = await DB.getAll('customers');
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message);
            } finally {
                state.isLoading = false;
            }
        }

        // Render Functions
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = renderMainApp();
            attachMainListeners();
        }

        function renderMainApp() {
            return `
                <div class="min-h-screen">
                    <header class="gradient-header">
                        <div class="px-4 py-4 flex items-center justify-between">
                            <button onclick="toggleMenu()" class="text-white text-xl">
                                <i class="fas fa-bars"></i>
                            </button>
                            <div class="text-center">
                                <h1 class="text-2xl font-bold">${state.settings.businessName} POS</h1>
                                <div class="text-xs opacity-90">World's Best POS System</div>
                            </div>
                            <button onclick="showSettings()" class="text-white text-xl">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        <div class="px-4 pb-3 overflow-x-auto flex gap-2">
                            ${['dashboard', 'sales', 'inventory', 'customers', 'purchases', 'suppliers', 'udhaar', 'offers', 'offerProgress', 'dayend'].map(page => `
                                <button 
                                    onclick="changePage('${page}')"
                                    class="px-4 py-2 rounded-t-lg whitespace-nowrap transition ${
                                        state.currentPage === page 
                                            ? 'bg-white text-purple-600 font-semibold' 
                                            : 'text-white hover:bg-white/20'
                                    }"
                                    ${state.isLoading ? 'disabled' : ''}
                                >
                                    <i class="fas fa-${getPageIcon(page)} mr-2"></i>
                                    ${getPageTitle(page)}
                                </button>
                            `).join('')}
                        </div>
                    </header>
                    <main class="p-4 max-w-7xl mx-auto">
                        <div id="page-content" class="page-content">
                            ${renderPage()}
                        </div>
                    </main>
                </div>
                <div class="floating-action-btn" onclick="quickAction()">
                    <i class="fas fa-plus"></i>
                </div>
            `;
        }

        function getPageIcon(page) {
            const icons = {
                dashboard: 'tachometer-alt',
                sales: 'shopping-cart',
                inventory: 'boxes',
                customers: 'users',
                purchases: 'truck-loading',
                suppliers: 'handshake',
                udhaar: 'file-invoice-dollar',
                offers: 'gift',
                offerProgress: 'chart-line',
                dayend: 'chart-bar'
            };
            return icons[page] || 'circle';
        }

        function getPageTitle(page) {
            const titles = {
                dashboard: 'Dashboard',
                sales: 'Sales',
                inventory: 'Inventory',
                customers: 'Customers',
                purchases: 'Purchases',
                suppliers: 'Suppliers',
                udhaar: 'Udhaar',
                offers: 'Offers',
                offerProgress: 'Offer Progress',
                dayend: 'Day End'
            };
            return titles[page] || page;
        }

        function renderPage() {
            if (state.isLoading) {
                return `
                    <div class="flex justify-center items-center py-12">
                        <div class="loading" style="width: 40px; height: 40px;"></div>
                    </div>
                `;
            }
            
            switch (state.currentPage) {
                case 'dashboard':
                    return renderDashboard();
                case 'inventory':
                    return renderInventory();
                case 'sales':
                    return renderSales();
                case 'customers':
                    return renderCustomers();
                case 'purchases':
                    return renderPurchases();
                case 'suppliers': 
                    return renderSuppliers();
                case 'udhaar':
                    return renderUdhaar();
                case 'offers':
                    return renderOffers();
                case 'offerProgress':
                    return renderOfferProgress();
                case 'dayend':
                    return renderDayEnd();
                default:
                    return '<div>Page not found</div>';
            }
        }

        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = (state.sales || []).filter(s => s.date.startsWith(today));
            const todayRevenue = todaySales.reduce((sum, s) => sum + s.total, 0);
            
            // Calculate profit (revenue - cost)
            const todayProfit = todaySales.reduce((sum, sale) => {
                const cost = sale.items.reduce((itemSum, item) => {
                    const inventoryItem = (state.inventory || []).find(i => i.id === item.id);
                    return itemSum + (inventoryItem ? inventoryItem.cost * item.quantity : 0);
                }, 0);
                return sum + (sale.total - cost);
            }, 0);
            
            const totalCustomerUdhaar = (state.customers || []).reduce((sum, c) => sum + (c.udhaar || 0), 0);
            
            // Calculate supplier udhaar
            let totalSupplierUdhaar = 0;
            state.supplierBalances.forEach(balance => {
                totalSupplierUdhaar += balance.balance || 0;
            });

            const cashSales = todaySales.filter(s => s.paymentMode === 'Cash').reduce((sum, s) => sum + s.total, 0);
            const onlineSales = todaySales.filter(s => s.paymentMode === 'Online').reduce((sum, s) => sum + s.total, 0);
            const udhaarSales = todaySales.filter(s => s.paymentMode === 'Udhaar').reduce((sum, s) => sum + s.total, 0);
            const totalSales = cashSales + onlineSales + udhaarSales;

            // Find customers eligible for rewards or ineligible due to udhaar
            const eligibleCustomers = [];
            const ineligibleCustomers = [];
            
            (state.customers || []).forEach(customer => {
                if (customer.name === 'Walk-In') return;
                
                const customerProgress = (state.offerProgress || []).filter(p => p.customerId === customer.id);
                
                customerProgress.forEach(progress => {
                    const offer = (state.offers || []).find(o => o.id === progress.offerId);
                    if (offer && progress.currentCount >= offer.targetQuantity) {
                        const alreadyRewarded = (state.rewards || []).some(r => 
                            r.customerId === customer.id && r.offerId === offer.id
                        );
                        
                        if (!alreadyRewarded) {
                            if ((customer.udhaar || 0) === 0) {
                                eligibleCustomers.push({
                                    customer,
                                    offer,
                                    progress
                                });
                            } else {
                                ineligibleCustomers.push({
                                    customer,
                                    offer,
                                    progress,
                                    reason: 'Has pending udhaar'
                                });
                            }
                        }
                    }
                });
            });

            // Create marquee message if there are ineligible customers
            let marqueeMessage = '';
            if (ineligibleCustomers.length > 0) {
                const names = ineligibleCustomers.map(item => item.customer.name).join(', ');
                marqueeMessage = `
                    <div class="marquee-container">
                        <div class="marquee">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            <strong>Important:</strong> The following customers are ineligible for rewards due to pending udhaar: ${names}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="welcome-banner">
                        <h1 class="text-3xl font-bold mb-2">Welcome to ${state.settings.businessName}</h1>
                        <p class="text-lg opacity-90">World's Best POS System - Ready to boost your business!</p>
                    </div>
                    
                    ${marqueeMessage}
                    
                    <div class="dashboard-grid">
                        <div class="stats-card">
                            <div class="text-2xl font-bold">${todaySales.length}</div>
                            <div class="text-sm opacity-90">Today's Sales</div>
                            <i class="fas fa-shopping-cart absolute bottom-4 right-4 text-2xl opacity-50"></i>
                        </div>
                        <div class="stats-card">
                            <div class="text-2xl font-bold">${state.settings.currency}${todayRevenue.toFixed(2)}</div>
                            <div class="text-sm opacity-90">Revenue</div>
                            <i class="fas fa-rupee-sign absolute bottom-4 right-4 text-2xl opacity-50"></i>
                        </div>
                        <div class="stats-card">
                            <div class="text-2xl font-bold">${state.settings.currency}${todayProfit.toFixed(2)}</div>
                            <div class="text-sm opacity-90">Profit</div>
                            <i class="fas fa-chart-line absolute bottom-4 right-4 text-2xl opacity-50"></i>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="quick-action" onclick="changePage('sales')">
                            <i class="fas fa-cash-register"></i>
                            <div class="font-semibold">New Sale</div>
                        </div>
                        <div class="quick-action" onclick="changePage('inventory')">
                            <i class="fas fa-boxes"></i>
                            <div class="font-semibold">Inventory</div>
                        </div>
                        <div class="quick-action" onclick="changePage('customers')">
                            <i class="fas fa-users"></i>
                            <div class="font-semibold">Customers</div>
                        </div>
                        <div class="quick-action" onclick="changePage('udhaar')">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <div class="font-semibold">Udhaar</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold text-lg mb-3">Today's Payment Breakdown</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-cash">Cash</span>
                                </div>
                                <span class="font-semibold">${state.settings.currency}${cashSales.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-online">Online</span>
                                </div>
                                <span class="font-semibold">${state.settings.currency}${onlineSales.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-udhaar">Udhaar (Sales)</span>
                                </div>
                                <span class="font-semibold">${state.settings.currency}${udhaarSales.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center border-t pt-2 mt-2">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold">Total</span>
                                </div>
                                <span class="font-bold text-lg">${state.settings.currency}${totalSales.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${eligibleCustomers.length > 0 ? `
                        <div class="card highlight-reward">
                            <h3 class="font-bold text-lg text-green-700 mb-3">
                                <i class="fas fa-gift mr-2"></i>Customers Eligible for Rewards
                            </h3>
                            <div class="space-y-2">
                                ${eligibleCustomers.map(item => `
                                    <div class="flex justify-between items-center p-2 rounded bg-green-50">
                                        <div>
                                            <div class="font-semibold">${item.customer.name}</div>
                                            <div class="text-sm text-gray-600">
                                                ${item.offer.title} (${item.progress.currentCount}/${item.offer.targetQuantity})
                                            </div>
                                        </div>
                                        <button onclick="grantReward(${item.offer.id}, ${item.customer.id})" class="btn bg-green-600 text-white text-sm">
                                            Grant Reward
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${ineligibleCustomers.length > 0 ? `
                        <div class="card highlight-ineligible">
                            <h3 class="font-bold text-lg text-red-700 mb-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Customers Ineligible Due to Udhaar
                            </h3>
                            <div class="space-y-2">
                                ${ineligibleCustomers.map(item => `
                                    <div class="flex justify-between items-center p-2 rounded bg-red-50">
                                        <div>
                                            <div class="font-semibold">${item.customer.name}</div>
                                            <div class="text-sm text-gray-600">
                                                ${item.offer.title} (${item.progress.currentCount}/${item.offer.targetQuantity})
                                            </div>
                                            <div class="text-xs text-red-600">Udhaar: ${state.settings.currency}${item.customer.udhaar.toFixed(2)}</div>
                                        </div>
                                        <span class="badge badge-ineligible">Ineligible</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-4">
                        <button onclick="showExportModal()" class="btn bg-green-600 text-white flex-1">
                            <i class="fas fa-download mr-2"></i>Export Data
                        </button>
                        <button onclick="showImportModal()" class="btn bg-blue-600 text-white flex-1">
                            <i class="fas fa-upload mr-2"></i>Import Data
                        </button>
                    </div>
                    
                    <div class="card bg-red-50 border-2 border-red-200">
                        <h3 class="font-bold text-lg text-red-700 mb-2">Total Outstanding Customer Udhaar (We are owed)</h3>
                        <div class="text-3xl font-bold text-red-600">${state.settings.currency}${totalCustomerUdhaar.toFixed(2)}</div>
                        <button onclick="changePage('udhaar')" class="mt-3 btn btn-primary w-full">
                            Manage Customer Udhaar
                        </button>
                    </div>
                    
                    <div class="card bg-yellow-50 border-2 border-yellow-200">
                        <h3 class="font-bold text-lg text-yellow-800 mb-2">Total Outstanding Supplier Udhaar (We owe)</h3>
                        <div class="text-3xl font-bold text-yellow-700">${state.settings.currency}${totalSupplierUdhaar.toFixed(2)}</div>
                        <button onclick="changePage('udhaar')" class="mt-3 btn btn-primary w-full bg-yellow-600 hover:bg-yellow-700">
                            Manage Supplier Udhaar
                        </button>
                    </div>
                </div>
            `;
        }

        function renderInventory() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Inventory Management</h2>
                        <button onclick="showAddItem()" class="btn btn-primary">+ Add Item</button>
                    </div>
                    <input 
                        type="text" 
                        id="inventory-search" 
                        placeholder="Search items..." 
                        class="input"
                        onkeyup="filterInventory()"
                    >
                    <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${(state.inventory || []).map(item => `
                            <div class="card inventory-item">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-gray-800 text-lg">${item.name}</div>
                                        <div class="text-sm text-gray-600">Cost: ${state.settings.currency}${item.cost.toFixed(2)} | Sell: ${state.settings.currency}${item.sellingPrice.toFixed(2)}</div>
                                        <div class="text-xs text-green-600 mt-1">Profit: ${state.settings.currency}${(item.sellingPrice - item.cost).toFixed(2)} (${((item.sellingPrice - item.cost) / item.cost * 100).toFixed(1)}%)</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editItem(${item.id})" class="text-blue-600 px-2 py-1 bg-blue-100 rounded">Edit</button>
                                        <button onclick="deleteItem(${item.id})" class="text-red-600 px-2 py-1 bg-red-100 rounded">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${(state.inventory || []).length === 0 ? `
                        <div class="card text-center py-12">
                            <i class="fas fa-boxes text-5xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-600 mb-2">No Items Yet</h3>
                            <p class="text-gray-500 mb-4">Add your first inventory item to get started</p>
                            <button onclick="showAddItem()" class="btn btn-primary">+ Add Your First Item</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSales() {
            // Get filtered sales based on date range
            const filteredSales = (state.sales || []).filter(sale => {
                const saleDate = sale.date.split('T')[0];
                return saleDate >= state.salesFilterFromDate && saleDate <= state.salesFilterToDate;
            }).slice().reverse().slice(0, 20);

            // Get most selling items
            const itemSales = {};
            state.sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = 0;
                    }
                    itemSales[item.name] += item.quantity;
                });
            });

            // Sort inventory by sales count (most selling first)
            const sortedInventory = [...state.inventory].sort((a, b) => {
                const aSales = itemSales[a.name] || 0;
                const bSales = itemSales[b.name] || 0;
                return bSales - aSales;
            });

            return `
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Sales & Billing</h2>
                    
                    <div class="card space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="font-semibold text-gray-700">Sale Date</label>
                            <input type="date" id="sale-date" class="input" value="${state.saleDate}" onchange="state.saleDate = this.value">
                        </div>
                        <label class="font-semibold text-gray-700">Customer</label>
                        <select id="customer-select" class="input" onchange="selectCustomer()">
                            <option value="">Walk-In Customer</option>
                            ${(state.customers || []).filter(c => c.name !== 'Walk-In').map(c => `
                                <option value="${c.id}" ${state.selectedCustomer && state.selectedCustomer.id === c.id ? 'selected' : ''}>
                                    ${c.name} ${c.mobile ? '(' + c.mobile + ')' : ''} ${c.udhaar > 0 ? ` [Udhaar: ${state.settings.currency}${c.udhaar.toFixed(2)}]` : ''}
                                </option>
                            `).join('')}
                        </select>
                        <button onclick="showAddCustomer()" class="btn btn-primary w-full mt-2">+ Add New Customer</button>
                    </div>
                    
                    <div class="card">
                        <label class="font-semibold text-gray-700 mb-2 block">Payment Mode</label>
                        <div id="payment-modes" class="grid grid-cols-3 gap-2">
                            <div class="payment-option ${state.selectedPaymentMode === 'Cash' ? 'selected' : ''}" data-mode="Cash" onclick="selectPaymentMode('Cash', event)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ’µ</div>
                                    <div class="font-semibold">Cash</div>
                                </div>
                            </div>
                            <div class="payment-option ${state.selectedPaymentMode === 'Online' ? 'selected' : ''}" data-mode="Online" onclick="selectPaymentMode('Online', event)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ’³</div>
                                    <div class="font-semibold">Online</div>
                                </div>
                            </div>
                            <div class="payment-option ${state.selectedPaymentMode === 'Udhaar' ? 'selected' : ''}" data-mode="Udhaar" onclick="selectPaymentMode('Udhaar', event)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ“</div>
                                    <div class="font-semibold">Udhaar</div>
                                </div>
                            </div>
                        </div>
                        <div id="udhaar-message"></div>
                    </div>

                    <div class="card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold">Select Items</h3>
                            <div class="search-container w-1/2">
                                <input 
                                    type="text" 
                                    id="item-search" 
                                    placeholder="Search items..." 
                                    class="input"
                                    onkeyup="searchItems()"
                                >
                                <div id="search-results" class="search-results hidden"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto">
                            ${sortedInventory.map(item => `
                                <button 
                                    onclick="addToCart(${item.id})"
                                    class="p-3 border-2 border-purple-300 rounded-lg hover:bg-purple-50 text-left inventory-item"
                                >
                                    <div class="font-semibold">${item.name}</div>
                                    <div class="text-sm text-gray-600">${state.settings.currency}${item.sellingPrice.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">Sold: ${itemSales[item.name] || 0}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div id="cart-section" class="card space-y-2 ${state.cart.length === 0 ? 'hidden' : ''}">
                        <h3 class="font-semibold">Cart</h3>
                        <div id="cart-items" class="space-y-2"></div>
                        <div id="cart-total" class="text-xl font-bold text-right pt-2 border-t"></div>
                        <button onclick="completeSale()" class="btn btn-primary w-full py-3 text-lg">Complete Sale</button>
                    </div>

                    <div class="card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold">Recent Sales</h3>
                            <div class="flex gap-2">
                                <input type="date" id="sales-from-date" class="input" value="${state.salesFilterFromDate}" onchange="state.salesFilterFromDate = this.value; changePage('sales')">
                                <span>to</span>
                                <input type="date" id="sales-to-date" class="input" value="${state.salesFilterToDate}" onchange="state.salesFilterToDate = this.value; changePage('sales')">
                            </div>
                        </div>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${filteredSales.map(sale => `
                                <div class="border rounded-lg p-3 sale-item">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-medium">${sale.customerName}</div>
                                            <div class="text-sm text-gray-600">
                                                ${new Date(sale.date).toLocaleString()}
                                            </div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="badge badge-${sale.paymentMode.toLowerCase()}">${sale.paymentMode}</span>
                                                <span class="font-semibold">${state.settings.currency}${sale.total.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <button onclick="viewSale(${sale.id})" class="text-blue-600">View</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${filteredSales.length === 0 ? '<div class="text-center text-gray-500 py-4">No sales found for selected date range</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomers() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Customer Management</h2>
                        <button onclick="showAddCustomer()" class="btn btn-primary">+ Add Customer</button>
                    </div>
                    <input 
                        type="text" 
                        id="customer-search" 
                        placeholder="Search customers..." 
                        class="input"
                        onkeyup="filterCustomers()"
                    >
                    <div id="customer-list" class="space-y-2">
                        ${(state.customers || []).map(customer => {
                            const customerSales = (state.sales || []).filter(s => s.customerId === customer.id);
                            const totalPurchases = customerSales.reduce((sum, s) => sum + s.total, 0);
                            const rewardCount = (state.rewards || []).filter(r => r.customerId === customer.id).length;
                            const udhaar = customer.udhaar || 0;

                            return `
                                <div class="card">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${customer.name}</div>
                                            ${customer.mobile ? `<div class="text-sm text-gray-600">${customer.mobile}</div>` : ''}
                                            <div class="text-sm text-gray-600 mt-1">
                                                Purchases: ${state.settings.currency}${totalPurchases.toFixed(2)} | Rewards: ${rewardCount}
                                            </div>
                                            ${udhaar > 0 ? `<div class="text-sm text-red-600 font-semibold">Udhaar: ${state.settings.currency}${udhaar.toFixed(2)}</div>` : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="viewCustomer(${customer.id})" class="text-blue-600 px-2">View</button>
                                            <button onclick="editCustomer(${customer.id})" class="text-green-600 px-2">Edit</button>
                                            <button onclick="deleteCustomer(${customer.id})" class="text-red-600 px-2">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderSuppliers() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Supplier Management</h2>
                        <button onclick="showAddSupplier()" class="btn btn-primary">+ Add Supplier</button>
                    </div>
                    <div class="space-y-2">
                        ${(state.suppliers || []).map(supplier => {
                            const supplierBalance = state.supplierBalances.find(b => b.supplierId === supplier.id);
                            const balance = supplierBalance ? supplierBalance.balance : 0;

                            return `
                                <div class="card">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${supplier.name}</div>
                                            ${supplier.mobile ? `<div class="text-sm text-gray-600">${supplier.mobile}</div>` : ''}
                                            <div class="text-sm text-gray-600 mt-1">
                                                Udhaar Balance (We Owe): <span class="text-yellow-700 font-semibold">${state.settings.currency}${balance.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="editSupplier(${supplier.id})" class="text-green-600 px-2">Edit</button>
                                            <button onclick="deleteSupplier(${supplier.id})" class="text-red-600 px-2">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${(state.suppliers || []).length === 0 ? '<div class="text-center text-gray-500 py-4">No suppliers added yet.</div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderPurchases() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Purchase Management</h2>
                        <div class="flex gap-2">
                            <button onclick="changePage('suppliers')" class="btn bg-blue-500 text-white">Manage Suppliers</button>
                            <button onclick="showAddPurchase()" class="btn btn-primary">+ Add Purchase</button>
                        </div>
                    </div>
                    <input 
                        type="text" 
                        id="purchase-search" 
                        placeholder="Search purchases..." 
                        class="input"
                        onkeyup="filterPurchases()"
                    >
                    <div id="purchase-list" class="space-y-2">
                        ${(state.purchases || []).slice().reverse().map(purchase => `
                            <div class="card">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-semibold">${purchase.itemName}</div>
                                        <div class="text-sm text-gray-600">
                                            Qty: ${purchase.quantity} Ã— Cost: ${state.settings.currency}${purchase.costPrice.toFixed(2)} = Total: ${state.settings.currency}${purchase.total.toFixed(2)}
                                        </div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="badge badge-${purchase.paymentMode.toLowerCase()}">${purchase.paymentMode}</span>
                                            ${purchase.supplierName ? `<span class="text-xs text-gray-700 ml-1">Supplier: ${purchase.supplierName}</span>` : ''}
                                            <span class="text-xs text-gray-500">${new Date(purchase.date).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderUdhaar() {
            const customersWithUdhaar = (state.customers || []).filter(c => (c.udhaar || 0) > 0); 
            const udhaarTransactions = (state.udhaarTransactions || []).slice().reverse();
            
            // Get suppliers with udhaar
            const suppliersWithUdhaar = state.suppliers.map(supplier => {
                const supplierBalance = state.supplierBalances.find(b => b.supplierId === supplier.id);
                const balance = supplierBalance ? supplierBalance.balance : 0;
                return { ...supplier, udhaar: balance };
            }).filter(s => s.udhaar > 0);
            
            const supplierUdhaarTransactions = (state.supplierUdhaarTransactions || []).slice().reverse();
            
            return `
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Udhaar Management</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card bg-red-50 border-2 border-red-200">
                            <h3 class="font-bold text-lg text-red-700 mb-2">Customer Udhaar (We are Owed)</h3>
                            <div class="text-3xl font-bold text-red-600">
                                ${state.settings.currency}${(state.customers || []).reduce((sum, c) => sum + (c.udhaar || 0), 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="card bg-yellow-50 border-2 border-yellow-200">
                            <h3 class="font-bold text-lg text-yellow-800 mb-2">Supplier Udhaar (We Owe)</h3>
                            <div class="text-3xl font-bold text-yellow-700">
                                ${state.settings.currency}${suppliersWithUdhaar.reduce((sum, s) => sum + s.udhaar, 0).toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card">
                            <h3 class="font-semibold mb-3">Customers with Pending Udhaar</h3>
                            <div class="space-y-2">
                                ${customersWithUdhaar.length === 0 ? 
                                    '<div class="text-center text-gray-500 py-4">No pending customer udhaar</div>' :
                                    customersWithUdhaar.map(customer => `
                                        <div class="border rounded-lg p-3">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="font-semibold">${customer.name}</div>
                                                    ${customer.mobile ? `<div class="text-sm text-gray-600">${customer.mobile}</div>` : ''}
                                                    <div class="text-lg font-bold text-red-600 mt-1">${state.settings.currency}${customer.udhaar.toFixed(2)}</div>
                                                </div>
                                                <button onclick="showUdhaarPayment(${customer.id})" class="btn btn-primary text-sm">
                                                    Record Payment
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="font-semibold mb-3">Suppliers with Pending Udhaar</h3>
                            <div class="space-y-2">
                                ${suppliersWithUdhaar.length === 0 ? 
                                    '<div class="text-center text-gray-500 py-4">No pending supplier udhaar</div>' :
                                    suppliersWithUdhaar.map(supplier => `
                                        <div class="border rounded-lg p-3">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="font-semibold">${supplier.name}</div>
                                                    ${supplier.mobile ? `<div class="text-sm text-gray-600">${supplier.mobile}</div>` : ''}
                                                    <div class="text-lg font-bold text-yellow-700 mt-1">${state.settings.currency}${supplier.udhaar.toFixed(2)}</div>
                                                </div>
                                                <button onclick="showSupplierUdhaarPayment(${supplier.id})" class="btn bg-yellow-600 text-white text-sm">
                                                    Record Payment
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card">
                            <h3 class="font-semibold mb-3">Recent Customer Udhaar Transactions</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${udhaarTransactions.length === 0 ?
                                    '<div class="text-center text-gray-500 py-4">No transactions yet</div>' :
                                    udhaarTransactions.map(txn => {
                                        const customer = (state.customers || []).find(c => c.id === txn.customerId);
                                        return `
                                            <div class="border rounded-lg p-3">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <div class="font-semibold">${customer ? customer.name : 'Unknown'}</div>
                                                        <div class="text-sm text-gray-600">
                                                            ${txn.type === 'payment' ? 'Paid' : 'Added'}: ${state.settings.currency}${txn.amount.toFixed(2)}
                                                        </div>
                                                        <div class="text-xs text-gray-500">${new Date(txn.date).toLocaleString()}</div>
                                                        ${txn.note ? `<div class="text-xs text-gray-600 mt-1">Note: ${txn.note}</div>` : ''}
                                                    </div>
                                                    <span class="badge ${txn.type === 'payment' ? 'badge-cash' : 'badge-udhaar'}">
                                                        ${txn.type === 'payment' ? 'Payment' : 'Udhaar'}
                                                    </span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="font-semibold mb-3">Recent Supplier Udhaar Transactions</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${supplierUdhaarTransactions.length === 0 ?
                                    '<div class="text-center text-gray-500 py-4">No transactions yet</div>' :
                                    supplierUdhaarTransactions.map(txn => {
                                        const supplier = (state.suppliers || []).find(s => s.id === txn.supplierId);
                                        return `
                                            <div class="border rounded-lg p-3">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <div class="font-semibold">${supplier ? supplier.name : 'Unknown'}</div>
                                                        <div class="text-sm text-gray-600">
                                                            ${txn.type === 'payment' ? 'Paid' : 'Added'}: ${state.settings.currency}${txn.amount.toFixed(2)}
                                                        </div>
                                                        <div class="text-xs text-gray-500">${new Date(txn.date).toLocaleString()}</div>
                                                        ${txn.note ? `<div class="text-xs text-gray-600 mt-1">Note: ${txn.note}</div>` : ''}
                                                    </div>
                                                    <span class="badge ${txn.type === 'payment' ? 'badge-cash' : 'badge-supplier'}">
                                                        ${txn.type === 'payment' ? 'Payment' : 'Udhaar'}
                                                    </span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOffers() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Offers & Rewards</h2>
                        <button onclick="showAddOffer()" class="btn btn-primary">+ Create Offer</button>
                    </div>
                    <div class="space-y-4">
                        ${(state.offers || []).map(offer => {
                            const offerRewards = (state.rewards || []).filter(r => r.offerId === offer.id);
                            
                            const eligibleCustomers = (state.customers || []).filter(c => {
                                const progress = (state.offerProgress || []).find(p => p.customerId === c.id && p.offerId === offer.id);
                                return progress && progress.currentCount >= offer.targetQuantity && (c.udhaar || 0) === 0;
                            });

                            return `
                                <div class="card">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg text-purple-600">${offer.title}</h3>
                                            <div class="text-sm text-gray-700 mt-2">
                                                Buy ${offer.targetQuantity} Ã— **${offer.targetItem}** â†’ Get **${offer.rewardItem}**
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                Valid: ${new Date(offer.startDate).toLocaleDateString()} - ${new Date(offer.endDate).toLocaleDateString()}
                                            </div>
                                            <div class="text-sm text-red-600 mt-1">${offer.terms}</div>
                                            <div class="mt-3">
                                                <button onclick="viewOfferRewards(${offer.id})" class="text-blue-600 hover:underline text-sm">
                                                    Total Rewards Granted: ${offerRewards.length}
                                                </button>
                                            </div>
                                            ${eligibleCustomers.length > 0 ? `
                                                <div class="mt-3 border-t pt-3">
                                                    <div class="font-semibold text-green-600 mb-2">Eligible Customers:</div>
                                                    ${eligibleCustomers.map(customer => {
                                                        const progress = (state.offerProgress || []).find(p => p.customerId === customer.id && p.offerId === offer.id);
                                                        return `
                                                            <div class="flex justify-between items-center mb-2">
                                                                <span class="text-sm">${customer.name} (${progress.currentCount}/${offer.targetQuantity})</span>
                                                                <button onclick="grantReward(${offer.id}, ${customer.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm">
                                                                    ðŸŽ Grant
                                                                </button>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="editOffer(${offer.id})" class="text-blue-600 px-2 py-1 bg-blue-100 rounded text-sm">Edit</button>
                                            <button onclick="deleteOffer(${offer.id})" class="text-red-600 px-2 py-1 bg-red-100 rounded text-sm">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderOfferProgress() {
            return `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Offer Progress Tracking</h2>
                    </div>
                    <div class="space-y-4">
                        ${(state.offerProgress || []).map(progress => {
                            const customer = (state.customers || []).find(c => c.id === progress.customerId);
                            const offer = (state.offers || []).find(o => o.id === progress.offerId);
                            
                            if (!customer || !offer) return '';
                            
                            const percentage = Math.min(100, (progress.currentCount / offer.targetQuantity) * 100);
                            const isEligible = progress.currentCount >= offer.targetQuantity;
                            const hasReward = (state.rewards || []).some(r => r.customerId === customer.id && r.offerId === offer.id);
                            
                            return `
                                <div class="card ${isEligible && !hasReward ? 'highlight-reward' : ''}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-center mb-2">
                                                <h3 class="font-bold text-lg">${customer.name}</h3>
                                                <span class="badge ${isEligible ? 'badge-reward' : 'badge-online'}">
                                                    ${isEligible ? 'Eligible' : 'In Progress'}
                                                </span>
                                            </div>
                                            <div class="text-sm text-gray-700">
                                                <strong>Offer:</strong> ${offer.title}
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                <strong>Progress:</strong> ${progress.currentCount} / ${offer.targetQuantity} ${offer.targetItem}
                                            </div>
                                            <div class="mt-2">
                                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                                <div class="text-xs text-gray-500 mt-1 text-right">${percentage.toFixed(1)}%</div>
                                            </div>
                                            ${isEligible && !hasReward ? `
                                                <div class="mt-3">
                                                    <button onclick="grantReward(${offer.id}, ${customer.id})" class="btn bg-green-600 text-white w-full">
                                                        Grant Reward (${offer.rewardItem})
                                                    </button>
                                                </div>
                                            ` : ''}
                                            ${hasReward ? `
                                                <div class="mt-2 text-sm text-green-600">
                                                    <i class="fas fa-check-circle mr-1"></i>Reward already granted
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${(state.offerProgress || []).length === 0 ? `
                            <div class="card text-center py-12">
                                <i class="fas fa-chart-line text-5xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-600 mb-2">No Offer Progress Yet</h3>
                                <p class="text-gray-500 mb-4">Customer offer progress will appear here as they make purchases</p>
                                <button onclick="changePage('offers')" class="btn btn-primary">Create Offers</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderDayEnd() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = (state.sales || []).filter(s => s.date.startsWith(today));

            const customerSummaries = (state.customers || []).map(customer => {
                const customerTodaySales = todaySales.filter(s => s.customerId === customer.id);
                if (customerTodaySales.length === 0) return null;

                const items = {};
                let total = 0;

                customerTodaySales.forEach(sale => {
                    total += sale.total;
                    sale.items.forEach(item => {
                        items[item.name] = (items[item.name] || 0) + item.quantity;
                    });
                });

                return { customer, items, total };
            }).filter(Boolean);

            // Calculate day end totals
            const totalSales = todaySales.length;
            const totalRevenue = todaySales.reduce((sum, s) => sum + s.total, 0);
            const customerCount = [...new Set(todaySales.map(s => s.customerId))].length;

            return `
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">Day End Summary</h2>
                    
                    <div class="card">
                        <div class="text-center">
                            <h3 class="text-xl font-bold">${new Date().toLocaleDateString()}</h3>
                            <div class="grid grid-cols-3 gap-4 mt-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${totalSales}</div>
                                    <div class="text-sm text-gray-600">Total Sales</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${state.settings.currency}${totalRevenue.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">Total Revenue</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${customerCount}</div>
                                    <div class="text-sm text-gray-600">Customers Served</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        ${customerSummaries.length} customers served today
                    </div>
                    
                    <div class="space-y-3">
                        ${customerSummaries.map(summary => `
                            <div class="card">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-lg">${summary.customer.name}</div>
                                        ${summary.customer.mobile ? `<div class="text-sm text-gray-600">${summary.customer.mobile}</div>` : ''}
                                    </div>
                                    <div class="text-xl font-bold text-purple-600">${state.settings.currency}${summary.total.toFixed(2)}</div>
                                </div>
                                <div class="text-sm text-gray-700">
                                    <strong>Items Purchased:</strong>
                                    ${Object.entries(summary.items).map(([name, qty]) => `
                                        <div>â€¢ ${name} Ã— ${qty}</div>
                                    `).join('')}
                                </div>
                                ${(summary.customer.udhaar || 0) > 0 ? `
                                    <div class="text-sm text-red-600 mt-2">
                                        Pending Udhaar: ${state.settings.currency}${summary.customer.udhaar.toFixed(2)}
                                    </div>
                                ` : ''}
                                ${summary.customer.mobile ? `
                                    <button onclick='shareWhatsApp(${JSON.stringify(summary).replace(/'/g, "\\'")})' class="mt-3 w-full bg-green-600 text-white py-2 rounded-lg text-sm font-semibold">
                                        Share on WhatsApp
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                        ${customerSummaries.length === 0 ? '<div class="card text-center text-gray-500 p-8">No sales recorded today</div>' : ''}
                    </div>
                </div>
            `;
        }

        // Navigation Functions
        function changePage(page) {
            if (state.isLoading) return;
            state.currentPage = page;
            render();
        }

        function toggleMenu() {
            const menuContent = `
                <div class="space-y-4">
                    <h3 class="text-xl font-bold">Swadist Adda POS System</h3>
                    <p>This is a multi-user, real-time POS system using IndexedDB for local storage.</p>
                    
                    <div class="space-y-2">
                        <h4 class="font-semibold">Pages:</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Dashboard:</strong> Daily summary</li>
                            <li><strong>Sales:</strong> POS interface</li>
                            <li><strong>Inventory:</strong> Item management</li>
                            <li><strong>Customers:</strong> Customer & Udhaar details</li>
                            <li><strong>Purchases:</strong> Inventory purchase tracking</li>
                            <li><strong>Suppliers:</strong> Supplier management</li>
                            <li><strong>Udhaar:</strong> Customer Debt management</li>
                            <li><strong>Offers:</strong> Loyalty programs</li>
                            <li><strong>Offer Progress:</strong> Track customer offer progress</li>
                            <li><strong>Day End:</strong> Sales summary per customer</li>
                        </ul>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <button onclick="showExportModal()" class="btn bg-green-600 text-white w-full mb-2">
                            <i class="fas fa-download mr-2"></i>Export Data
                        </button>
                        <button onclick="showImportModal()" class="btn bg-blue-600 text-white w-full">
                            <i class="fas fa-upload mr-2"></i>Import Data
                        </button>
                    </div>
                </div>
            `;
            
            createModal('Menu & Information', menuContent);
        }

        // Enhanced Export Modal with All Sales Date Export
        function showExportModal() {
            createModal('Export Data', `
                <div class="space-y-4">
                    <h3 class="font-bold text-lg">Select Export Type</h3>
                    
                    <div class="export-options">
                        <div class="card export-card" onclick="showAllSalesExport()">
                            <div class="text-center">
                                <div class="text-3xl mb-2">ðŸ“Š</div>
                                <h4 class="font-semibold">All Sales Report</h4>
                                <p class="text-sm text-gray-600">Date-wise sales with customer details, items, and totals</p>
                            </div>
                        </div>
                        
                        <div class="card export-card" onclick="showGeneralExport()">
                            <div class="text-center">
                                <div class="text-3xl mb-2">ðŸ“</div>
                                <h4 class="font-semibold">General Data Export</h4>
                                <p class="text-sm text-gray-600">Export inventory, customers, suppliers, offers, etc.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeModal()" class="btn bg-gray-400 text-white w-full">Cancel</button>
                </div>
            `);
        }

        function showAllSalesExport() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            createModal('Export All Sales Report', `
                <div class="space-y-4">
                    <h3 class="font-bold text-lg">All Sales Date-wise Report</h3>
                    
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Date Range</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-sm text-gray-600">From Date</label>
                                <input type="date" id="all-sales-from-date" class="input" value="${thirtyDaysAgo.toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">To Date</label>
                                <input type="date" id="all-sales-to-date" class="input" value="${today.toISOString().split('T')[0]}">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Include Customers</label>
                        <select id="export-customer-filter" class="input">
                            <option value="all">All Customers</option>
                            <option value="with_udhaar">Only Customers with Udhaar</option>
                            <option value="without_udhaar">Only Customers without Udhaar</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Export Format</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="export-excel" class="mr-2" checked>
                                <span>Excel File (.xlsx) with detailed sheets</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-pdf" class="mr-2" checked>
                                <span>PDF Report (.pdf) for printing</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="pdf-preview" class="pdf-preview hidden">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-file-pdf text-3xl mb-2"></i>
                            <div>PDF Preview will generate when you export</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="exportAllSalesReport()" class="btn bg-green-600 text-white flex-1">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                        <button onclick="previewPDF()" class="btn bg-purple-600 text-white flex-1">
                            <i class="fas fa-eye mr-2"></i>Preview PDF
                        </button>
                        <button onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </div>
            `);
        }

        function showGeneralExport() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            createModal('General Data Export', `
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Export Date Range</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-sm text-gray-600">From Date</label>
                                <input type="date" id="export-from-date" class="input" value="${thirtyDaysAgo.toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">To Date</label>
                                <input type="date" id="export-to-date" class="input" value="${today.toISOString().split('T')[0]}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Data to Export</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="export-sales" class="mr-2" checked>
                                <span>Sales Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-customers" class="mr-2" checked>
                                <span>Customers Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-inventory" class="mr-2" checked>
                                <span>Inventory Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-purchases" class="mr-2" checked>
                                <span>Purchases Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-suppliers" class="mr-2" checked>
                                <span>Suppliers Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="export-offers" class="mr-2" checked>
                                <span>Offers Data</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="handleGeneralExport()" class="btn bg-green-600 text-white flex-1">Export as Excel</button>
                        <button onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </div>
            `);
        }

        // Function to validate date range
        function validateDateRange(fromDate, toDate) {
            if (new Date(fromDate) > new Date(toDate)) {
                showToast('From date cannot be after To date');
                return false;
            }
            return true;
        }

        // Function to generate All Sales Report Data
        function getAllSalesReportData(fromDate, toDate, customerFilter) {
            if (!validateDateRange(fromDate, toDate)) {
                return null;
            }

            const filteredSales = (state.sales || []).filter(sale => {
                const saleDate = sale.date.split('T')[0];
                return saleDate >= fromDate && saleDate <= toDate;
            });

            // Group sales by customer and date
            const customerData = {};
            
            filteredSales.forEach(sale => {
                const customer = (state.customers || []).find(c => c.id === sale.customerId);
                if (!customer) return;
                
                // Apply customer filter
                if (customerFilter === 'with_udhaar' && (customer.udhaar || 0) <= 0) return;
                if (customerFilter === 'without_udhaar' && (customer.udhaar || 0) > 0) return;
                
                const saleDate = sale.date.split('T')[0];
                const key = `${customer.id}_${saleDate}`;
                
                if (!customerData[key]) {
                    customerData[key] = {
                        customerId: customer.id,
                        customerName: customer.name,
                        mobile: customer.mobile || 'N/A',
                        date: saleDate,
                        totalSales: 0,
                        totalAmount: 0,
                        items: {},
                        paymentModes: {}
                    };
                }
                
                customerData[key].totalSales += 1;
                customerData[key].totalAmount += sale.total;
                
                // Count payment modes
                customerData[key].paymentModes[sale.paymentMode] = 
                    (customerData[key].paymentModes[sale.paymentMode] || 0) + sale.total;
                
                // Aggregate items
                sale.items.forEach(item => {
                    if (!customerData[key].items[item.name]) {
                        customerData[key].items[item.name] = {
                            quantity: 0,
                            total: 0
                        };
                    }
                    customerData[key].items[item.name].quantity += item.quantity;
                    customerData[key].items[item.name].total += item.quantity * item.sellingPrice;
                });
            });

            // Convert to array format for export (matching your Excel format)
            const reportData = [];
            Object.values(customerData).forEach(data => {
                // Add customer summary row
                reportData.push({
                    'Customer Name': data.customerName,
                    'Mobile': data.mobile,
                    'Date': data.date,
                    'Total Sales': data.totalSales,
                    'Total Amount': data.totalAmount,
                    'Items': 'SUMMARY',
                    'Quantity': '',
                    'Item Total': '',
                    'Payment Mode': Object.entries(data.paymentModes).map(([mode, amount]) => 
                        `${mode}: ${state.settings.currency}${amount.toFixed(2)}`
                    ).join(', ')
                });
                
                // Add item details
                Object.entries(data.items).forEach(([itemName, itemData]) => {
                    reportData.push({
                        'Customer Name': '',
                        'Mobile': '',
                        'Date': '',
                        'Total Sales': '',
                        'Total Amount': '',
                        'Items': itemName,
                        'Quantity': itemData.quantity,
                        'Item Total': state.settings.currency + itemData.total.toFixed(2),
                        'Payment Mode': ''
                    });
                });
                
                // Add separator
                reportData.push({
                    'Customer Name': '---',
                    'Mobile': '---',
                    'Date': '---',
                    'Total Sales': '---',
                    'Total Amount': '---',
                    'Items': '---',
                    'Quantity': '---',
                    'Item Total': '---',
                    'Payment Mode': '---'
                });
            });

            // Add summary totals
            const totalCustomers = Object.keys(customerData).length;
            const totalSales = filteredSales.length;
            const totalAmount = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            
            reportData.push({
                'Customer Name': 'GRAND TOTAL',
                'Mobile': '',
                'Date': '',
                'Total Sales': totalSales,
                'Total Amount': totalAmount,
                'Items': '',
                'Quantity': '',
                'Item Total': '',
                'Payment Mode': `Period: ${fromDate} to ${toDate}`
            });

            return {
                rawData: filteredSales,
                reportData,
                summary: {
                    fromDate,
                    toDate,
                    totalCustomers,
                    totalSales,
                    totalAmount,
                    customerFilter
                }
            };
        }

        // Export All Sales Report Function
        async function exportAllSalesReport() {
            try {
                const fromDate = document.getElementById('all-sales-from-date').value;
                const toDate = document.getElementById('all-sales-to-date').value;
                const customerFilter = document.getElementById('export-customer-filter').value;
                const exportExcel = document.getElementById('export-excel').checked;
                const exportPDF = document.getElementById('export-pdf').checked;
                
                if (!fromDate || !toDate) {
                    showToast('Please select both from and to dates');
                    return;
                }

                if (!validateDateRange(fromDate, toDate)) {
                    return;
                }

                showSyncIndicator();
                
                const reportData = getAllSalesReportData(fromDate, toDate, customerFilter);
                if (!reportData) {
                    hideSyncIndicator();
                    return;
                }
                
                if (exportExcel) {
                    await exportExcelReport(reportData, fromDate, toDate);
                }
                
                if (exportPDF) {
                    await generatePDFReport(reportData, fromDate, toDate);
                }
                
                hideSyncIndicator();
                closeModal();
                
                let successMsg = 'Report exported successfully!';
                if (exportExcel && exportPDF) {
                    successMsg = 'Excel and PDF reports exported successfully!';
                } else if (exportExcel) {
                    successMsg = 'Excel report exported successfully!';
                } else if (exportPDF) {
                    successMsg = 'PDF report exported successfully!';
                }
                
                showToast(successMsg);
                
            } catch (error) {
                console.error('Export error:', error);
                hideSyncIndicator();
                showToast('Error exporting report: ' + error.message);
            }
        }

        // Export Excel Report - MATCHING YOUR FORMAT EXACTLY
        async function exportExcelReport(reportData, fromDate, toDate) {
            const wb = XLSX.utils.book_new();
            
            // 1. Summary Sheet (EXACT MATCH TO YOUR FORMAT)
            const summaryData = [{
                'Business Name': state.settings.businessName,
                'Report Type': 'All Sales Date-wise Report',
                'From Date': fromDate,
                'To Date': toDate,
                'Total Customers': reportData.summary.totalCustomers,
                'Total Sales': reportData.summary.totalSales,
                'Total Amount': state.settings.currency + reportData.summary.totalAmount.toFixed(2),
                'Generated At': new Date().toLocaleString(),
                'Customer Filter': reportData.summary.customerFilter.replace('_', ' ')
            }];
            const summarySheet = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, "Summary");
            
            // 2. Sales Report Sheet (EXACT MATCH TO YOUR FORMAT)
            const salesReportData = reportData.reportData;
            const salesReportSheet = XLSX.utils.json_to_sheet(salesReportData);
            XLSX.utils.book_append_sheet(wb, salesReportSheet, "Sales Report");
            
            // 3. Raw Data Sheet (EXACT MATCH TO YOUR FORMAT)
            const rawDataSheet = reportData.rawData.map(sale => {
                const customer = (state.customers || []).find(c => c.id === sale.customerId);
                
                // Create item columns dynamically
                const row = {
                    'Sale ID': sale.id,
                    'Date': new Date(sale.date).toLocaleString(),
                    'Customer Name': sale.customerName,
                    'Customer Mobile': customer ? customer.mobile : 'N/A',
                    'Items Count': sale.items.length,
                    'Total Amount': sale.total,
                    'Tax Amount': sale.tax || 0,
                    'Payment Mode': sale.paymentMode
                };
                
                // Add each item as a separate column
                sale.items.forEach(item => {
                    row[item.name] = item.quantity;
                });
                
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rawDataSheet), "Raw Data");
            
            // 4. Customer Summary Sheet (EXACT MATCH TO YOUR FORMAT)
            const customersSummary = [];
            const customerMap = {};
            
            reportData.rawData.forEach(sale => {
                if (!customerMap[sale.customerId]) {
                    const customer = (state.customers || []).find(c => c.id === sale.customerId);
                    if (customer) {
                        customerMap[sale.customerId] = {
                            'Customer ID': customer.id,
                            'Customer Name': customer.name,
                            'Mobile': customer.mobile || '',
                            'Total Purchases': 0,
                            'Total Amount': 0,
                            'Udhaar Balance': customer.udhaar || 0,
                            'Sales Count': 0
                        };
                    }
                }
                
                if (customerMap[sale.customerId]) {
                    customerMap[sale.customerId].TotalAmount += sale.total;
                    customerMap[sale.customerId].SalesCount += 1;
                    customerMap[sale.customerId].TotalPurchases += sale.items.reduce((sum, item) => sum + item.quantity, 0);
                }
            });
            
            Object.values(customerMap).forEach(customer => {
                customersSummary.push(customer);
            });
            
            // Add all customers (even those without sales in the period)
            state.customers.forEach(customer => {
                if (!customerMap[customer.id] && customer.name !== 'Walk-In') {
                    customersSummary.push({
                        'Customer ID': customer.id,
                        'Customer Name': customer.name,
                        'Mobile': customer.mobile || '',
                        'Total Purchases': 0,
                        'Total Amount': 0,
                        'Udhaar Balance': customer.udhaar || 0,
                        'Sales Count': 0
                    });
                }
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(customersSummary), "Customer Summary");
            
            // Generate file with your exact naming format
            const fileName = `all-sales-report-${fromDate}-to-${toDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Generate PDF Report
        async function generatePDFReport(reportData, fromDate, toDate) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Header
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 40);
                doc.text(state.settings.businessName, 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('A branch of The Swadist Group', 105, 28, { align: 'center' });
                
                // Report Title
                doc.setFontSize(16);
                doc.setTextColor(60, 60, 60);
                doc.text('All Sales Date-wise Report', 105, 40, { align: 'center' });
                
                // Period
                doc.setFontSize(11);
                doc.text(`Period: ${fromDate} to ${toDate}`, 105, 48, { align: 'center' });
                
                // Summary Box
                doc.setDrawColor(200, 200, 200);
                doc.setFillColor(245, 245, 245);
                doc.roundedRect(20, 55, 170, 25, 3, 3, 'FD');
                
                doc.setFontSize(10);
                doc.setTextColor(80, 80, 80);
                doc.text('Generated: ' + new Date().toLocaleString(), 30, 65);
                doc.text('Total Customers: ' + reportData.summary.totalCustomers, 100, 65);
                doc.text('Total Sales: ' + reportData.summary.totalSales, 140, 65);
                
                doc.setFontSize(11);
                doc.setTextColor(40, 40, 40);
                doc.text('Total Amount: ' + state.settings.currency + reportData.summary.totalAmount.toFixed(2), 30, 75);
                
                // Table Data Preparation
                const tableData = reportData.reportData
                    .filter(row => row['Customer Name'] !== '---' && row['Customer Name'] !== 'GRAND TOTAL')
                    .map(row => [
                        row['Customer Name'] || '',
                        row['Mobile'] || '',
                        row['Date'] || '',
                        row['Items'] || '',
                        row['Quantity'] || '',
                        row['Item Total'] || '',
                        row['Payment Mode'] || ''
                    ]);
                
                // Add Grand Total at the end
                tableData.push([
                    'GRAND TOTAL',
                    '',
                    '',
                    '',
                    '',
                    state.settings.currency + reportData.summary.totalAmount.toFixed(2),
                    `Period: ${fromDate} to ${toDate}`
                ]);
                
                // Create Table
                doc.autoTable({
                    startY: 90,
                    head: [['Customer', 'Mobile', 'Date', 'Items', 'Qty', 'Amount', 'Payment Mode']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [93, 51, 234], textColor: 255 },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 30 },
                        4: { cellWidth: 15 },
                        5: { cellWidth: 25 },
                        6: { cellWidth: 30 }
                    },
                    margin: { left: 10, right: 10 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    didDrawPage: function (data) {
                        // Footer
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Page ' + doc.internal.getNumberOfPages(), 105, 285, { align: 'center' });
                        doc.text('Swadist Adda POS System - World\'s Best POS', 105, 290, { align: 'center' });
                    }
                });
                
                // Save PDF
                const fileName = `all-sales-report-${fromDate}-to-${toDate}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        // Preview PDF
        function previewPDF() {
            const fromDate = document.getElementById('all-sales-from-date').value;
            const toDate = document.getElementById('all-sales-to-date').value;
            const customerFilter = document.getElementById('export-customer-filter').value;
            
            if (!fromDate || !toDate) {
                showToast('Please select both from and to dates');
                return;
            }
            
            if (!validateDateRange(fromDate, toDate)) {
                return;
            }
            
            const reportData = getAllSalesReportData(fromDate, toDate, customerFilter);
            if (!reportData) return;
            
            // Create preview in modal
            const previewContent = `
                <div class="space-y-4">
                    <h3 class="font-bold text-lg">PDF Preview</h3>
                    <div class="pdf-preview">
                        <div class="text-center mb-4">
                            <h4 class="text-xl font-bold">${state.settings.businessName}</h4>
                            <p class="text-sm text-gray-600">A branch of The Swadist Group</p>
                            <h5 class="text-lg font-semibold mt-2">All Sales Date-wise Report</h5>
                            <p class="text-sm">Period: ${fromDate} to ${toDate}</p>
                        </div>
                        
                        <div class="bg-gray-100 p-3 rounded mb-4">
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div>
                                    <strong>Generated:</strong><br>
                                    ${new Date().toLocaleString()}
                                </div>
                                <div>
                                    <strong>Total Customers:</strong><br>
                                    ${reportData.summary.totalCustomers}
                                </div>
                                <div>
                                    <strong>Total Sales:</strong><br>
                                    ${reportData.summary.totalSales}
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>Total Amount:</strong> ${state.settings.currency}${reportData.summary.totalAmount.toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-purple-600 text-white">
                                    <tr>
                                        <th class="p-2 text-left">Customer</th>
                                        <th class="p-2 text-left">Mobile</th>
                                        <th class="p-2 text-left">Date</th>
                                        <th class="p-2 text-left">Items</th>
                                        <th class="p-2 text-left">Qty</th>
                                        <th class="p-2 text-left">Amount</th>
                                        <th class="p-2 text-left">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reportData.reportData.slice(0, 10).map(row => `
                                        <tr class="border-b">
                                            <td class="p-2">${row['Customer Name'] || ''}</td>
                                            <td class="p-2">${row['Mobile'] || ''}</td>
                                            <td class="p-2">${row['Date'] || ''}</td>
                                            <td class="p-2">${row['Items'] || ''}</td>
                                            <td class="p-2">${row['Quantity'] || ''}</td>
                                            <td class="p-2">${row['Item Total'] || ''}</td>
                                            <td class="p-2">${row['Payment Mode'] || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${reportData.reportData.length > 10 ? 
                                `<div class="text-center text-gray-500 mt-2">... and ${reportData.reportData.length - 10} more rows</div>` : 
                                ''
                            }
                        </div>
                        
                        <div class="mt-4 text-center text-sm text-gray-500">
                            This is a preview. The actual PDF will contain all ${reportData.reportData.length} rows.
                        </div>
                    </div>
                    
                    <button onclick="closeModal()" class="btn bg-gray-600 text-white w-full">Close Preview</button>
                </div>
            `;
            
            createModal('PDF Report Preview', previewContent);
        }

        // General Export Function
        async function handleGeneralExport() {
            try {
                const fromDate = document.getElementById('export-from-date').value;
                const toDate = document.getElementById('export-to-date').value;
                
                if (!fromDate || !toDate) {
                    showToast('Please select both from and to dates');
                    return;
                }
                
                if (!validateDateRange(fromDate, toDate)) {
                    return;
                }
                
                const exportData = {
                    metadata: {
                        exportedAt: new Date().toISOString(),
                        fromDate,
                        toDate,
                        version: DB.version,
                        exportedBy: state.settings.businessName,
                        recordCounts: {
                            inventory: state.inventory.length,
                            customers: state.customers.length,
                            sales: state.sales.length,
                            purchases: state.purchases.length,
                            suppliers: state.suppliers.length,
                            offers: state.offers.length
                        }
                    },
                    sales: document.getElementById('export-sales').checked ? 
                        (state.sales || []).filter(s => {
                            const saleDate = s.date.split('T')[0];
                            return saleDate >= fromDate && saleDate <= toDate;
                        }) : [],
                    customers: document.getElementById('export-customers').checked ? state.customers : [],
                    inventory: document.getElementById('export-inventory').checked ? state.inventory : [],
                    purchases: document.getElementById('export-purchases').checked ? 
                        (state.purchases || []).filter(p => {
                            const purchaseDate = p.date.split('T')[0];
                            return purchaseDate >= fromDate && purchaseDate <= toDate;
                        }) : [],
                    suppliers: document.getElementById('export-suppliers').checked ? state.suppliers : [],
                    offers: document.getElementById('export-offers').checked ? state.offers : [],
                    rewards: document.getElementById('export-offers').checked ? state.rewards : [],
                    offerProgress: document.getElementById('export-offers').checked ? state.offerProgress : [],
                    udhaarTransactions: document.getElementById('export-customers').checked ? state.udhaarTransactions : [],
                    supplierUdhaarTransactions: document.getElementById('export-suppliers').checked ? state.supplierUdhaarTransactions : [],
                    supplierBalances: document.getElementById('export-suppliers').checked ? state.supplierBalances : []
                };

                // Create Excel workbook
                const wb = XLSX.utils.book_new();
                
                // Add metadata sheet
                const metadataSheet = XLSX.utils.json_to_sheet([exportData.metadata]);
                XLSX.utils.book_append_sheet(wb, metadataSheet, "Metadata");
                
                // Add data sheets
                if (exportData.sales.length > 0) {
                    const salesSheet = XLSX.utils.json_to_sheet(exportData.sales);
                    XLSX.utils.book_append_sheet(wb, salesSheet, "Sales");
                }
                
                if (exportData.customers.length > 0) {
                    const customersSheet = XLSX.utils.json_to_sheet(exportData.customers);
                    XLSX.utils.book_append_sheet(wb, customersSheet, "Customers");
                }
                
                if (exportData.inventory.length > 0) {
                    const inventorySheet = XLSX.utils.json_to_sheet(exportData.inventory);
                    XLSX.utils.book_append_sheet(wb, inventorySheet, "Inventory");
                }
                
                if (exportData.purchases.length > 0) {
                    const purchasesSheet = XLSX.utils.json_to_sheet(exportData.purchases);
                    XLSX.utils.book_append_sheet(wb, purchasesSheet, "Purchases");
                }
                
                if (exportData.suppliers.length > 0) {
                    const suppliersSheet = XLSX.utils.json_to_sheet(exportData.suppliers);
                    XLSX.utils.book_append_sheet(wb, suppliersSheet, "Suppliers");
                }
                
                if (exportData.offers.length > 0) {
                    const offersSheet = XLSX.utils.json_to_sheet(exportData.offers);
                    XLSX.utils.book_append_sheet(wb, offersSheet, "Offers");
                }
                
                if (exportData.rewards.length > 0) {
                    const rewardsSheet = XLSX.utils.json_to_sheet(exportData.rewards);
                    XLSX.utils.book_append_sheet(wb, rewardsSheet, "Rewards");
                }
                
                // Generate Excel file and download
                XLSX.writeFile(wb, `swadist-adda-export-${fromDate}-to-${toDate}.xlsx`);
                
                closeModal();
                showToast(`Data exported successfully! ${exportData.sales.length} sales, ${exportData.customers.length} customers, ${exportData.inventory.length} items`);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data: ' + error.message);
            }
        }

        function showImportModal() {
            createModal('Import Data', `
                <div class="space-y-4">
                    <h3 class="font-bold text-lg">Import All Sales Report</h3>
                    <p class="text-sm text-gray-600">
                        You can import the Excel files exported from this system. 
                        The import will merge data with existing records. Duplicates will be skipped.
                    </p>
                    
                    <div class="space-y-2">
                        <label class="font-semibold text-gray-700 mb-2 block">Import Mode</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="import-mode" value="merge" class="mr-2" checked>
                                <span>Merge with existing data (Recommended)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="import-mode" value="replace" class="mr-2">
                                <span>Replace all data (Dangerous)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="font-semibold text-gray-700 mb-2 block">Import Type</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="import-type" value="all_sales" class="mr-2" checked>
                                <span>All Sales Report (Excel with multiple sheets)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="import-type" value="general" class="mr-2">
                                <span>General Data Export</span>
                            </label>
                        </div>
                    </div>
                    
                    <input type="file" id="import-file" accept=".xlsx,.xls" class="input">
                    
                    <div class="flex gap-2">
                        <button onclick="handleImport()" class="btn bg-blue-600 text-white flex-1">
                            <i class="fas fa-upload mr-2"></i>Import File
                        </button>
                        <button onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </div>
            `);
        }

        // Helper function to import sheet data with duplicate checking
        async function importSheetData(sheetName, storeName, sheetData, importStats, importMode) {
            if (!sheetData[sheetName] || !Array.isArray(sheetData[sheetName])) {
                return;
            }

            const existingData = await DB.getAll(storeName);
            
            for (const item of sheetData[sheetName]) {
                try {
                    // Remove old ID to allow auto-increment
                    const { id, ...cleanItem } = item;
                    
                    // Check for duplicates in merge mode
                    if (importMode === 'merge') {
                        let isDuplicate = false;
                        
                        if (storeName === 'inventory') {
                            isDuplicate = existingData.some(existing => 
                                existing.name === cleanItem.name
                            );
                        } else if (storeName === 'customers') {
                            isDuplicate = existingData.some(existing => 
                                existing.name === cleanItem.name && 
                                existing.mobile === cleanItem.mobile
                            );
                        } else if (storeName === 'sales') {
                            isDuplicate = existingData.some(existing => 
                                existing.customerId === cleanItem.customerId &&
                                existing.date === cleanItem.date &&
                                existing.total === cleanItem.total
                            );
                        } else if (storeName === 'suppliers') {
                            isDuplicate = existingData.some(existing => 
                                existing.name === cleanItem.name
                            );
                        }
                        
                        if (isDuplicate) {
                            importStats.skipped++;
                            continue;
                        }
                    }
                    
                    await DB.add(storeName, cleanItem);
                    importStats[storeName]++;
                    
                } catch (error) {
                    console.warn(`Failed to import item in ${storeName}:`, error);
                    importStats.skipped++;
                }
            }
        }

        async function handleImport() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) {
                showToast('Please select a file to import');
                return;
            }
            
            const importMode = document.querySelector('input[name="import-mode"]:checked').value;
            const importType = document.querySelector('input[name="import-type"]:checked').value;
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    showSyncIndicator();
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Parse each sheet
                    const sheetData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        sheetData[sheetName] = XLSX.utils.sheet_to_json(worksheet);
                    });
                    
                    let importStats = {
                        inventory: 0,
                        customers: 0,
                        sales: 0,
                        purchases: 0,
                        suppliers: 0,
                        offers: 0,
                        rewards: 0,
                        skipped: 0
                    };

                    // Clear existing data only if replace mode is selected
                    if (importMode === 'replace') {
                        if (!confirm('WARNING: This will DELETE ALL existing data and replace it with imported data. Are you sure?')) {
                            hideSyncIndicator();
                            return;
                        }
                        
                        const stores = ['inventory', 'customers', 'sales', 'purchases', 'offers', 'rewards', 'offerProgress', 'udhaarTransactions', 'suppliers', 'supplierUdhaarTransactions', 'supplierBalances'];
                        
                        for (const store of stores) {
                            const items = await DB.getAll(store);
                            for (const item of items) {
                                await DB.delete(store, item.id);
                            }
                        }
                        
                        // Reset state
                        state.cart = [];
                        state.selectedCustomer = null;
                        state.selectedPaymentMode = 'Cash';
                    }

                    if (importType === 'all_sales') {
                        // Import All Sales Report format (YOUR EXACT FORMAT)
                        await importAllSalesReport(sheetData, importStats, importMode);
                    } else {
                        // Import General Data format
                        await importGeneralData(sheetData, importStats, importMode);
                    }

                    // Reload all data
                    await loadData();
                    
                    // Ensure Walk-In customer exists
                    if (!state.customers.find(c => c.name === 'Walk-In')) {
                        await DB.add('customers', {
                            name: 'Walk-In',
                            mobile: '',
                            udhaar: 0,
                            createdAt: new Date().toISOString()
                        });
                        state.customers = await DB.getAll('customers');
                    }
                    
                    closeModal();
                    hideSyncIndicator();
                    
                    // Show import summary
                    const summary = [];
                    if (importStats.inventory > 0) summary.push(`${importStats.inventory} items`);
                    if (importStats.customers > 0) summary.push(`${importStats.customers} customers`);
                    if (importStats.sales > 0) summary.push(`${importStats.sales} sales`);
                    if (importStats.purchases > 0) summary.push(`${importStats.purchases} purchases`);
                    if (importStats.suppliers > 0) summary.push(`${importStats.suppliers} suppliers`);
                    if (importStats.offers > 0) summary.push(`${importStats.offers} offers`);
                    if (importStats.skipped > 0) summary.push(`${importStats.skipped} duplicates skipped`);
                    
                    showToast(`Import successful! Added: ${summary.join(', ')}`);
                    changePage('dashboard');
                    
                } catch (error) {
                    console.error('Import error:', error);
                    hideSyncIndicator();
                    showToast('Error importing data: ' + error.message);
                }
            };
            
            reader.onerror = () => {
                hideSyncIndicator();
                showToast('Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
        }

        async function importAllSalesReport(sheetData, importStats, importMode) {
            // Import from All Sales Report format (YOUR EXACT FORMAT)
            if (sheetData['Sales Report']) {
                // Process sales data from your format
                const salesData = sheetData['Sales Report']
                    .filter(row => row['Customer Name'] && row['Customer Name'] !== '---' && row['Customer Name'] !== 'GRAND TOTAL' && row['Items'] === 'SUMMARY')
                    .map(row => {
                        return {
                            customerName: row['Customer Name'],
                            date: new Date(row['Date']).toISOString(),
                            total: row['Total Amount'] || 0,
                            paymentMode: row['Payment Mode'] ? row['Payment Mode'].split(':')[0] : 'Cash',
                            items: [] // Would need to reconstruct from item rows
                        };
                    });
                
                if (salesData.length > 0) {
                    for (const sale of salesData) {
                        await DB.add('sales', sale);
                        importStats.sales++;
                    }
                }
            }
            
            if (sheetData['Customer Summary']) {
                await importSheetData('Customer Summary', 'customers', sheetData, importStats, importMode);
            }
            
            if (sheetData['Raw Data']) {
                // Process raw data sheet
                const rawData = sheetData['Raw Data'];
                for (const row of rawData) {
                    // Reconstruct sale from raw data
                    const sale = {
                        id: row['Sale ID'],
                        customerName: row['Customer Name'],
                        date: new Date(row['Date']).toISOString(),
                        total: row['Total Amount'] || 0,
                        tax: row['Tax Amount'] || 0,
                        paymentMode: row['Payment Mode'] || 'Cash',
                        items: []
                    };
                    
                    // Add items from columns (like in your Excel)
                    Object.keys(row).forEach(key => {
                        if (key !== 'Sale ID' && key !== 'Date' && key !== 'Customer Name' && 
                            key !== 'Customer Mobile' && key !== 'Items Count' && key !== 'Total Amount' &&
                            key !== 'Tax Amount' && key !== 'Payment Mode') {
                            if (row[key] && row[key] > 0) {
                                sale.items.push({
                                    name: key,
                                    quantity: row[key],
                                    sellingPrice: 0 // Would need to get from inventory
                                });
                            }
                        }
                    });
                    
                    await DB.add('sales', sale);
                    importStats.sales++;
                }
            }
        }

        async function importGeneralData(sheetData, importStats, importMode) {
            // Import from General Data format
            await importSheetData('Inventory', 'inventory', sheetData, importStats, importMode);
            await importSheetData('Customers', 'customers', sheetData, importStats, importMode);
            await importSheetData('Sales', 'sales', sheetData, importStats, importMode);
            await importSheetData('Purchases', 'purchases', sheetData, importStats, importMode);
            await importSheetData('Suppliers', 'suppliers', sheetData, importStats, importMode);
            await importSheetData('Offers', 'offers', sheetData, importStats, importMode);
            await importSheetData('Rewards', 'rewards', sheetData, importStats, importMode);
            await importSheetData('OfferProgress', 'offerProgress', sheetData, importStats, importMode);
            await importSheetData('UdhaarTransactions', 'udhaarTransactions', sheetData, importStats, importMode);
            await importSheetData('SupplierUdhaarTransactions', 'supplierUdhaarTransactions', sheetData, importStats, importMode);
            await importSheetData('SupplierBalances', 'supplierBalances', sheetData, importStats, importMode);
        }

        // Quick Action for Floating Button
        function quickAction() {
            const actions = {
                dashboard: () => showAddItem(),
                inventory: () => showAddItem(),
                sales: () => completeSale(),
                customers: () => showAddCustomer(),
                purchases: () => showAddPurchase(),
                suppliers: () => showAddSupplier(),
                udhaar: () => showUdhaarPayment(state.customers.find(c => c.udhaar > 0)?.id),
                offers: () => showAddOffer(),
                offerProgress: () => changePage('offers'),
                dayend: () => shareDayEndReport()
            };
            
            if (actions[state.currentPage]) {
                actions[state.currentPage]();
            } else {
                // Default action - create new sale
                changePage('sales');
            }
        }

        // Settings Modal
        function showSettings() {
            createModal('Settings', `
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Business Name</label>
                        <input type="text" id="business-name" value="${state.settings.businessName}" class="input" required>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Currency Symbol</label>
                        <input type="text" id="currency" value="${state.settings.currency}" class="input" maxlength="3" required>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Tax Rate (%)</label>
                        <input type="number" id="tax-rate" value="${state.settings.taxRate}" class="input" min="0" max="100" step="0.1">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="print-receipts" ${state.settings.printReceipts ? 'checked' : ''} class="mr-2">
                            <span>Auto-print receipts</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Save Settings</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                state.settings.businessName = document.getElementById('business-name').value;
                state.settings.currency = document.getElementById('currency').value;
                state.settings.taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;
                state.settings.printReceipts = document.getElementById('print-receipts').checked;
                
                // Save to database
                const existingSettings = await DB.getAll('settings');
                if (existingSettings.length > 0) {
                    await DB.update('settings', { ...existingSettings[0], ...state.settings });
                } else {
                    await DB.add('settings', state.settings);
                }
                
                closeModal();
                showToast('Settings saved successfully!');
                render();
            });
        }

        // Sales Functions
        function updatePaymentModeUI() {
            const udhaarOption = document.querySelector('#payment-modes [data-mode="Udhaar"]');
            const udhaarMessageDiv = document.getElementById('udhaar-message');
            
            if (!udhaarOption || !udhaarMessageDiv) return;

            const customer = state.selectedCustomer;

            // Udhaar is now always enabled for named customers
            const isUdhaarDisabled = !customer;
            
            if (isUdhaarDisabled) {
                udhaarOption.classList.add('disabled');
                if (state.selectedPaymentMode === 'Udhaar') {
                    state.selectedPaymentMode = 'Cash';
                }
            } else {
                udhaarOption.classList.remove('disabled');
            }
            
            document.querySelectorAll('#payment-modes .payment-option').forEach(el => {
                 el.classList.remove('selected');
                 if (el.dataset.mode === state.selectedPaymentMode) {
                     el.classList.add('selected');
                 }
            });

            if (!customer) {
                udhaarMessageDiv.innerHTML = `<div class="text-sm text-red-600 font-semibold mt-2">Udhaar requires a named customer (not Walk-In).</div>`;
            }
            else if ((customer.udhaar || 0) > 0) {
                udhaarMessageDiv.innerHTML = `<div class="text-sm text-orange-600 font-semibold mt-2">Selected customer has pending Udhaar of ${state.settings.currency}${customer.udhaar.toFixed(2)}. New udhaar will be added to existing balance.</div>`;
            } else {
                udhaarMessageDiv.innerHTML = '';
            }
        }

        function selectPaymentMode(mode, event) {
            if (state.isLoading) return;
            
            const target = event.target.closest('.payment-option');
            if (target.classList.contains('disabled')) {
                showToast('Udhaar not allowed for Walk-In customers.');
                return;
            }
            state.selectedPaymentMode = mode;
            updatePaymentModeUI();
        }

        function selectCustomer() {
            if (state.isLoading) return;
            
            const select = document.getElementById('customer-select');
            if (!select) return;
            
            const customerId = parseInt(select.value);
            const customer = customerId ? state.customers.find(c => c.id === customerId) : null;
            state.selectedCustomer = customer;
            
            setTimeout(() => {
                updatePaymentModeUI(); 
                updateCart(); 
            }, 50);
        }

        // Search items function
        function searchItems() {
            const searchTerm = document.getElementById('item-search').value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm.length === 0) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredItems = state.inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredItems.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No items found</div>';
            } else {
                resultsContainer.innerHTML = filteredItems.map(item => `
                    <div class="search-result-item" onclick="addToCart(${item.id}); document.getElementById('item-search').value=''; document.getElementById('search-results').classList.add('hidden');">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-600">${state.settings.currency}${item.sellingPrice.toFixed(2)}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.classList.remove('hidden');
        }

        function addToCart(itemId) {
            if (state.isLoading) return;
            
            const item = (state.inventory || []).find(i => i.id === itemId);
            if (!item) return;

            const existing = state.cart.find(c => c.id === itemId);
            if (existing) {
                existing.quantity++;
            } else {
                state.cart.push({ 
                    id: item.id,
                    name: item.name,
                    sellingPrice: item.sellingPrice,
                    quantity: 1 
                });
            }
            updateCart();
        }

        function updateCartQuantity(itemId, delta) {
            if (state.isLoading) return;
            
            const item = state.cart.find(c => c.id === itemId);
            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) {
                    state.cart = state.cart.filter(c => c.id !== itemId);
                }
            }
            updateCart();
        }

        function updateCart() {
            const cartSection = document.getElementById('cart-section');
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');

            if (!cartSection || !cartItems || !cartTotal) return; 

            const total = state.cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);

            if (state.cart.length === 0) {
                cartSection.classList.add('hidden');
                cartTotal.textContent = `Total: ${state.settings.currency}0.00`;
                return;
            }

            cartSection.classList.remove('hidden');
            
            cartItems.innerHTML = state.cart.map(item => `
                <div class="flex justify-between items-center border-b pb-2">
                    <div>
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-600">${state.settings.currency}${item.sellingPrice.toFixed(2)} Ã— ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateCartQuantity(${item.id}, -1)" class="w-8 h-8 bg-red-100 text-red-600 rounded">-</button>
                        <span class="w-8 text-center">${item.quantity}</span>
                        <button onclick="updateCartQuantity(${item.id}, 1)" class="w-8 h-8 bg-green-100 text-green-600 rounded">+</button>
                    </div>
                </div>
            `).join('');

            cartTotal.textContent = `Total: ${state.settings.currency}${total.toFixed(2)}`;
        }

        async function completeSale() {
            if (state.isLoading) return;
            
            if (state.cart.length === 0) {
                showToast('Cart is empty!');
                return;
            }

            if (state.selectedPaymentMode === 'Udhaar' && !state.selectedCustomer) {
                showToast('Udhaar not allowed: Please select a named customer (not Walk-In).');
                return;
            }

            try {
                state.isLoading = true;
                render();
                
                let customer = state.selectedCustomer;
                
                if (!customer) {
                    customer = state.customers.find(c => c.name === 'Walk-In');
                }
                
                const total = state.cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
                const taxAmount = total * (state.settings.taxRate / 100);
                const finalTotal = total + taxAmount;
                
                // Create sale date with selected date and current time
                const saleDateTime = new Date(state.saleDate + 'T' + new Date().toTimeString().split(' ')[0]);
                
                const sale = {
                    customerId: customer.id,
                    customerName: customer.name,
                    items: state.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        sellingPrice: item.sellingPrice
                    })),
                    total: finalTotal,
                    tax: taxAmount,
                    paymentMode: state.selectedPaymentMode,
                    date: saleDateTime.toISOString()
                };

                await DB.add('sales', sale);
                
                if (state.selectedPaymentMode === 'Udhaar') {
                    const updatedCustomer = state.customers.find(c => c.id === customer.id);
                    updatedCustomer.udhaar = (updatedCustomer.udhaar || 0) + finalTotal;
                    await DB.update('customers', updatedCustomer);
                    
                    await DB.add('udhaarTransactions', {
                        customerId: customer.id,
                        amount: finalTotal,
                        type: 'udhaar',
                        note: 'Sale on credit',
                        date: saleDateTime.toISOString()
                    });
                }
                
                for (const item of state.cart) {
                    await updateOfferProgress(customer.id, item, item.quantity);
                }
                
                await loadData();
                
                // Show success message with receipt
                showReceipt(sale, customer);
                
                state.cart = [];
                state.selectedCustomer = null;
                state.selectedPaymentMode = 'Cash';
                state.saleDate = new Date().toISOString().split('T')[0];
                showToast('Sale completed successfully!');
                changePage('sales');
            } catch (error) {
                console.error('Sale completion error:', error);
                showToast('Error completing sale: ' + error.message);
            } finally {
                state.isLoading = false;
            }
        }

        async function updateOfferProgress(customerId, item, quantity) {
            const now = new Date();
            const activeOffers = (state.offers || []).filter(o => {
                const start = new Date(o.startDate);
                const end = new Date(o.endDate);
                return now >= start && now <= end && o.targetItem === item.name;
            });

            for (const offer of activeOffers) {
                let progress = (state.offerProgress || []).find(p => p.customerId === customerId && p.offerId === offer.id);
                
                if (progress) {
                    progress.currentCount += quantity;
                    await DB.update('offerProgress', progress);
                } else {
                    await DB.add('offerProgress', {
                        customerId,
                        offerId: offer.id,
                        currentCount: quantity
                    });
                }
            }
        }

        function viewSale(saleId) {
            const sale = (state.sales || []).find(s => s.id === saleId);
            if (!sale) return;

            createModal('Sale Details', `
                <div class="space-y-2">
                    <div><strong>Customer:</strong> ${sale.customerName}</div>
                    <div><strong>Date:</strong> ${new Date(sale.date).toLocaleString()}</div>
                    <div><strong>Payment:</strong> <span class="badge badge-${sale.paymentMode.toLowerCase()}">${sale.paymentMode}</span></div>
                    <div class="border-t pt-2 mt-2">
                        <strong>Items:</strong>
                        ${sale.items.map(item => `
                            <div class="ml-4 text-sm">â€¢ ${item.name} Ã— ${item.quantity} = ${state.settings.currency}${(item.sellingPrice * item.quantity).toFixed(2)}</div>
                        `).join('')}
                    </div>
                    <div class="border-t pt-2 mt-2 text-lg font-bold">
                        Total: ${state.settings.currency}${sale.total.toFixed(2)}
                    </div>
                </div>
                <button onclick="closeModal()" class="btn bg-gray-600 text-white w-full mt-4">Close</button>
            `);
        }

        // Show receipt after sale
        function showReceipt(sale, customer) {
            const receiptContent = `
                <div id="receipt-content" class="text-center">
                    <h2 class="text-xl font-bold">${state.settings.businessName}</h2>
                    <div class="text-sm text-gray-600 mb-1">A branch of The Swadist Group</div>
                    <div class="text-sm text-gray-600 mb-4">Receipt</div>
                    
                    <div class="text-left space-y-2 mb-4">
                        <div><strong>Customer:</strong> ${customer.name}</div>
                        <div><strong>Date:</strong> ${new Date(sale.date).toLocaleString()}</div>
                        <div><strong>Payment:</strong> ${sale.paymentMode}</div>
                    </div>
                    
                    <div class="border-t border-b py-2 mb-4">
                        ${sale.items.map(item => `
                            <div class="flex justify-between">
                                <span>${item.name} Ã— ${item.quantity}</span>
                                <span>${state.settings.currency}${(item.sellingPrice * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${sale.tax > 0 ? `
                        <div class="flex justify-between mb-2">
                            <span>Tax (${state.settings.taxRate}%):</span>
                            <span>${state.settings.currency}${sale.tax.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span>${state.settings.currency}${sale.total.toFixed(2)}</span>
                    </div>
                    
                    <div class="mt-6 text-sm text-gray-500">
                        Thank you for your business!
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button onclick="printReceipt()" class="btn btn-primary flex-1">Print Receipt</button>
                    <button onclick="shareReceiptOnWhatsApp(${JSON.stringify(sale).replace(/'/g, "\\'")}, ${JSON.stringify(customer).replace(/'/g, "\\'")})" class="btn bg-green-600 text-white flex-1">
                        <i class="fab fa-whatsapp mr-2"></i>Share
                    </button>
                    <button onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Close</button>
                </div>
            `;
            
            createModal('Sale Receipt', receiptContent);
        }

        // Print receipt - FIXED to print only receipt
        function printReceipt() {
            const receiptContent = document.getElementById('receipt-content');
            if (!receiptContent) {
                showToast('Receipt content not found');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Receipt - ${state.settings.businessName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .receipt { max-width: 300px; margin: 0 auto; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .items { margin: 20px 0; }
                            .total { font-weight: bold; font-size: 18px; margin-top: 20px; }
                            .footer { margin-top: 30px; text-align: center; color: #666; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // FIXED: Share receipt on WhatsApp
        function shareReceiptOnWhatsApp(sale, customer) {
            try {
                const itemsList = sale.items.map(item => 
                    `â€¢ ${item.name} Ã— ${item.quantity} = ${state.settings.currency}${(item.quantity * item.sellingPrice).toFixed(2)}`
                ).join('\n');

                const taxMessage = sale.tax > 0 ? 
                    `Tax (${state.settings.taxRate}%): ${state.settings.currency}${sale.tax.toFixed(2)}\n` : '';

                const message = `*${state.settings.businessName} - Receipt*\nA branch of The Swadist Group\n\n*Customer:* ${customer.name}\n*Date:* ${new Date(sale.date).toLocaleString()}\n*Payment:* ${sale.paymentMode}\n\n*Items:*\n${itemsList}\n\n${taxMessage}*Total: ${state.settings.currency}${sale.total.toFixed(2)}*\n\nThank you for your business!`;
                
                // Encode the message properly
                const encodedMessage = encodeURIComponent(message);
                
                // Check if customer has mobile number
                let whatsappUrl;
                if (customer.mobile) {
                    const cleanMobile = customer.mobile.replace(/[^0-9]/g, '');
                    whatsappUrl = `https://wa.me/${cleanMobile}?text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                }
                
                // Open in new window
                window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                
            } catch (error) {
                console.error('WhatsApp share error:', error);
                showToast('Error sharing to WhatsApp: ' + error.message);
            }
        }

        // FIXED: WhatsApp Share Function
        function shareWhatsApp(summaryString) {
            try {
                const summary = JSON.parse(summaryString);
                
                if (!summary.customer.mobile) {
                    showToast('Customer has no mobile number on record.');
                    return;
                }
                
                const itemsList = Object.entries(summary.items)
                    .map(([name, qty]) => `â€¢ ${name} Ã— ${qty}`)
                    .join('\n');

                const udhaarMessage = (summary.customer.udhaar || 0) > 0 
                    ? `\n\n*âš ï¸ Please note: You have a pending Udhaar of ${state.settings.currency}${summary.customer.udhaar.toFixed(2)}.*` 
                    : '';

                const message = `*${state.settings.businessName} â€” Day Summary*\n\nDear ${summary.customer.name},\n\nToday you purchased:\n${itemsList}\n\n*Total Sale: ${state.settings.currency}${summary.total.toFixed(2)}*${udhaarMessage}\n\nThank you for visiting!`;
                
                // Clean mobile number
                const mobile = summary.customer.mobile.replace(/[^0-9]/g, '');
                if (mobile.length < 10) {
                    showToast('Invalid mobile number format. WhatsApp share aborted.');
                    return;
                }

                // Proper WhatsApp URL format
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${mobile}?text=${encodedMessage}`;
                
                // Open in new tab
                window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                
            } catch (error) {
                console.error('WhatsApp share error:', error);
                showToast('Error sharing to WhatsApp: ' + error.message);
            }
        }

        // Inventory Functions
        function showAddItem() {
            const modal = createModal('Add Item', `
                <form id="item-form" class="space-y-4">
                    <input type="text" id="item-name" placeholder="Item Name" class="input" required>
                    <input type="number" step="0.01" id="item-cost" placeholder="Cost Price" class="input" required>
                    <input type="number" step="0.01" id="item-price" placeholder="Selling Price" class="input" required>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Add</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('item-name').value.trim();
                const cost = parseFloat(document.getElementById('item-cost').value);
                const sellingPrice = parseFloat(document.getElementById('item-price').value);
                
                if (!name) {
                    showToast('Item Name cannot be empty.');
                    return;
                }

                const exists = (state.inventory || []).find(i => i.name.toLowerCase() === name.toLowerCase());
                if (exists) {
                    showToast('Item already exists!');
                    return;
                }
                
                if (isNaN(cost) || isNaN(sellingPrice)) {
                    showToast('Cost and Selling Price must be valid numbers.');
                    return;
                }

                await DB.add('inventory', { name, cost, sellingPrice, createdAt: new Date().toISOString() });
                await loadData();
                closeModal();
                changePage('inventory');
            });
        }

        async function editItem(id) {
            const item = (state.inventory || []).find(i => i.id === id);
            if (!item) return;

            const modal = createModal('Edit Item', `
                <form id="edit-item-form" class="space-y-4">
                    <input type="text" id="edit-item-name" value="${item.name}" class="input" required>
                    <input type="number" step="0.01" id="edit-item-cost" value="${item.cost.toFixed(2)}" class="input" required>
                    <input type="number" step="0.01" id="edit-item-price" value="${item.sellingPrice.toFixed(2)}" class="input" required>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Update</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('edit-item-name').value.trim();
                const cost = parseFloat(document.getElementById('edit-item-cost').value);
                const sellingPrice = parseFloat(document.getElementById('edit-item-price').value);

                if (!name) {
                    showToast('Item Name cannot be empty.');
                    return;
                }
                 if (isNaN(cost) || isNaN(sellingPrice)) {
                    showToast('Cost and Selling Price must be valid numbers.');
                    return;
                }

                await DB.update('inventory', { id, name, cost, sellingPrice, createdAt: item.createdAt });
                await loadData();
                closeModal();
                changePage('inventory');
            });
        }

        async function deleteItem(id) {
            if (!confirm('Are you sure you want to permanently delete this item?')) return;
            await DB.delete('inventory', id);
            await loadData();
            changePage('inventory');
        }

        function filterInventory() {
            const search = document.getElementById('inventory-search').value.toLowerCase();
            const items = (state.inventory || []).filter(i => i.name.toLowerCase().includes(search));
            
            document.getElementById('inventory-list').innerHTML = items.map(item => `
                <div class="card inventory-item">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-gray-800 text-lg">${item.name}</div>
                            <div class="text-sm text-gray-600">Cost: ${state.settings.currency}${item.cost.toFixed(2)} | Sell: ${state.settings.currency}${item.sellingPrice.toFixed(2)}</div>
                            <div class="text-xs text-green-600 mt-1">Profit: ${state.settings.currency}${(item.sellingPrice - item.cost).toFixed(2)} (${((item.sellingPrice - item.cost) / item.cost * 100).toFixed(1)}%)</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editItem(${item.id})" class="text-blue-600 px-2 py-1 bg-blue-100 rounded">Edit</button>
                            <button onclick="deleteItem(${item.id})" class="text-red-600 px-2 py-1 bg-red-100 rounded">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Customer Functions
        function showAddCustomer() {
            const modal = createModal('Add Customer', `
                <form id="customer-form" class="space-y-4">
                    <input type="text" id="customer-name" placeholder="Customer Name" class="input" required>
                    <input type="tel" id="customer-mobile" placeholder="Mobile Number (optional)" class="input" pattern="[0-9]{10}">
                    <input type="number" step="0.01" id="customer-udhaar" placeholder="Initial Udhaar (if any)" value="0.00" class="input">
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Add</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('customer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('customer-name').value.trim();
                const mobile = document.getElementById('customer-mobile').value.trim();
                const udhaar = parseFloat(document.getElementById('customer-udhaar').value) || 0;
                
                if (!name) {
                    showToast('Customer Name cannot be empty.');
                    return;
                }
                
                // Validate mobile number if provided
                if (mobile && !/^\d{10}$/.test(mobile)) {
                    showToast('Please enter a valid 10-digit mobile number');
                    return;
                }
                
                if (isNaN(udhaar) || udhaar < 0) {
                     showToast('Initial Udhaar must be a valid non-negative number.');
                    return;
                }

                await DB.add('customers', { name, mobile, udhaar, createdAt: new Date().toISOString() });
                await loadData();
                closeModal();
                if (state.currentPage === 'sales') {
                    changePage('sales'); 
                } else {
                    changePage('customers');
                }
            });
        }

        async function editCustomer(id) {
            const customer = (state.customers || []).find(c => c.id === id);
            if (!customer) return;

            const modal = createModal('Edit Customer', `
                <form id="edit-customer-form" class="space-y-4">
                    <input type="text" id="edit-customer-name" value="${customer.name}" class="input" required>
                    <input type="tel" id="edit-customer-mobile" value="${customer.mobile || ''}" placeholder="Mobile Number" class="input" pattern="[0-9]{10}">
                    <div class="bg-gray-100 p-3 rounded text-sm text-gray-700">
                        Current Udhaar: <span class="text-red-600 font-bold">${state.settings.currency}${(customer.udhaar || 0).toFixed(2)}</span>
                        <div class="text-xs mt-1">Use the **Udhaar** page to manage payments.</div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Update</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('edit-customer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('edit-customer-name').value.trim();
                const mobile = document.getElementById('edit-customer-mobile').value.trim();
                
                if (!name) {
                    showToast('Customer Name cannot be empty.');
                    return;
                }
                
                // Validate mobile number if provided
                if (mobile && !/^\d{10}$/.test(mobile)) {
                    showToast('Please enter a valid 10-digit mobile number');
                    return;
                }

                await DB.update('customers', { ...customer, name, mobile });
                await loadData();
                closeModal();
                changePage('customers');
            });
        }

        async function deleteCustomer(id) {
            const customer = (state.customers || []).find(c => c.id === id);
            if (!customer) return;

            if ((customer.udhaar || 0) > 0) {
                showToast(`Cannot delete ${customer.name}. Customer has an outstanding Udhaar of ${state.settings.currency}${customer.udhaar.toFixed(2)}. Please settle the debt first.`);
                return;
            }

            if (!confirm(`Are you sure you want to permanently delete customer: ${customer.name}?`)) return;
            
            await DB.delete('customers', id);
            await loadData();
            changePage('customers');
        }

        function viewCustomer(id) {
            const customer = (state.customers || []).find(c => c.id === id);
            if (!customer) return;

            const customerSales = (state.sales || []).filter(s => s.customerId === id);
            const totalPurchases = customerSales.reduce((sum, s) => sum + s.total, 0);
            const itemsPurchased = {};
            
            customerSales.forEach(sale => {
                sale.items.forEach(item => {
                    itemsPurchased[item.name] = (itemsPurchased[item.name] || 0) + item.quantity;
                });
            });

            const rewardCount = (state.rewards || []).filter(r => r.customerId === id).length;

            createModal('Customer Details', `
                <div class="space-y-2">
                    <h3 class="text-xl font-bold">${customer.name}</h3>
                    ${customer.mobile ? `<div><strong>Mobile:</strong> ${customer.mobile}</div>` : ''}
                    <div><strong>Total Purchases:</strong> ${state.settings.currency}${totalPurchases.toFixed(2)}</div>
                    <div><strong>Rewards Received:</strong> ${rewardCount}</div>
                    ${(customer.udhaar || 0) > 0 ? `<div class="text-red-600"><strong>Udhaar:</strong> ${state.settings.currency}${customer.udhaar.toFixed(2)}</div>` : ''}
                    <div class="border-t pt-2 mt-2">
                        <strong>Items Purchased:</strong>
                        ${Object.entries(itemsPurchased).map(([item, qty]) => `
                            <div class="ml-4 text-sm">â€¢ ${item} Ã— ${qty}</div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="closeModal()" class="btn bg-gray-600 text-white w-full mt-4">Close</button>
            `);
        }

        function filterCustomers() {
            const search = document.getElementById('customer-search').value.toLowerCase();
            const filtered = (state.customers || []).filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.mobile && c.mobile.includes(search))
            );

            document.getElementById('customer-list').innerHTML = filtered.map(customer => {
                const customerSales = (state.sales || []).filter(s => s.customerId === customer.id);
                const totalPurchases = customerSales.reduce((sum, s) => sum + s.total, 0);
                const rewardCount = (state.rewards || []).filter(r => r.customerId === customer.id).length;
                const udhaar = customer.udhaar || 0;
                
                return `
                    <div class="card">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${customer.name}</div>
                                ${customer.mobile ? `<div class="text-sm text-gray-600">${customer.mobile}</div>` : ''}
                                <div class="text-sm text-gray-600 mt-1">
                                    Purchases: ${state.settings.currency}${totalPurchases.toFixed(2)} | Rewards: ${rewardCount}
                                </div>
                                ${udhaar > 0 ? `<div class="text-sm text-red-600 font-semibold">Udhaar: ${state.settings.currency}${udhaar.toFixed(2)}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewCustomer(${customer.id})" class="text-blue-600 px-2">View</button>
                                <button onclick="editCustomer(${customer.id})" class="text-green-600 px-2">Edit</button>
                                <button onclick="deleteCustomer(${customer.id})" class="text-red-600 px-2">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Supplier Functions
        function showAddSupplier() {
            const modal = createModal('Add Supplier', `
                <form id="supplier-form" class="space-y-4">
                    <input type="text" id="supplier-name" placeholder="Supplier Name" class="input" required>
                    <input type="tel" id="supplier-mobile" placeholder="Mobile Number (optional)" class="input" pattern="[0-9]{10}">
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Add</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('supplier-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('supplier-name').value.trim();
                const mobile = document.getElementById('supplier-mobile').value.trim();
                
                if (!name) {
                    showToast('Supplier Name cannot be empty.');
                    return;
                }
                
                // Validate mobile number if provided
                if (mobile && !/^\d{10}$/.test(mobile)) {
                    showToast('Please enter a valid 10-digit mobile number');
                    return;
                }
                
                await DB.add('suppliers', { name, mobile, createdAt: new Date().toISOString() });
                await loadData();
                closeModal();
                changePage('suppliers');
            });
        }

        async function editSupplier(id) {
            const supplier = (state.suppliers || []).find(s => s.id === id);
            if (!supplier) return;

            const modal = createModal('Edit Supplier', `
                <form id="edit-supplier-form" class="space-y-4">
                    <input type="text" id="edit-supplier-name" value="${supplier.name}" class="input" required>
                    <input type="tel" id="edit-supplier-mobile" value="${supplier.mobile || ''}" placeholder="Mobile Number" class="input" pattern="[0-9]{10}">
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Update</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('edit-supplier-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('edit-supplier-name').value.trim();
                const mobile = document.getElementById('edit-supplier-mobile').value.trim();
                
                if (!name) {
                    showToast('Supplier Name cannot be empty.');
                    return;
                }
                
                // Validate mobile number if provided
                if (mobile && !/^\d{10}$/.test(mobile)) {
                    showToast('Please enter a valid 10-digit mobile number');
                    return;
                }

                await DB.update('suppliers', { ...supplier, name, mobile });
                await loadData();
                closeModal();
                changePage('suppliers');
            });
        }
        
        async function deleteSupplier(id) {
            const supplier = (state.suppliers || []).find(s => s.id === id);
            if (!supplier) return;
            
            // Check if supplier has udhaar balance
            const supplierBalance = state.supplierBalances.find(b => b.supplierId === id);
            if (supplierBalance && supplierBalance.balance > 0) {
                showToast(`Cannot delete ${supplier.name}. Supplier has an outstanding Udhaar balance of ${state.settings.currency}${supplierBalance.balance.toFixed(2)}. Please settle the debt first.`);
                return;
            }
            
            if (!confirm(`Are you sure you want to permanently delete supplier: ${supplier.name}?`)) return;
            
            await DB.delete('suppliers', id);
            await loadData();
            changePage('suppliers');
        }

        // Purchase Functions - FIXED
        function showAddPurchase() {
            createModal('Add Purchase', `
                <form id="purchase-form" class="space-y-4">
                    <input type="text" id="purchase-item" placeholder="Item Name (e.g., Bread)" class="input" required>
                    <input type="number" id="purchase-quantity" placeholder="Quantity" min="1" value="1" class="input" required>
                    <input type="number" step="0.01" id="purchase-cost" placeholder="Cost Price (per item)" class="input" required>
                    
                    <div id="supplier-select-container" class="space-y-2">
                        <label class="font-semibold text-gray-700">Select Supplier</label>
                        <select id="purchase-supplier-id" class="input">
                            <option value="">-- Select Supplier --</option>
                            ${(state.suppliers || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                        <button type="button" onclick="closeModal(); showAddSupplier()" class="btn bg-gray-200 text-gray-800 w-full mt-2 text-sm">
                            + Add New Supplier
                        </button>
                    </div>

                    <div>
                        <label class="font-semibold text-gray-700 mb-2 block">Payment Mode</label>
                        <div id="purchase-payment-modes" class="grid grid-cols-3 gap-2">
                            <div class="payment-option selected" data-mode="Cash" onclick="selectPurchasePaymentMode('Cash', this)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ’µ</div>
                                    <div class="font-semibold text-sm">Cash</div>
                                </div>
                            </div>
                            <div class="payment-option" data-mode="Online" onclick="selectPurchasePaymentMode('Online', this)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ’³</div>
                                    <div class="font-semibold text-sm">Online</div>
                                </div>
                            </div>
                            <div class="payment-option" data-mode="Udhaar" onclick="selectPurchasePaymentMode('Udhaar', this)">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">ðŸ“</div>
                                    <div class="font-semibold text-sm">Udhaar</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Add Purchase</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            // Initialize purchase payment mode
            window.selectPurchasePaymentMode = function(mode, element) {
                document.querySelectorAll('#purchase-payment-modes .payment-option').forEach(opt => opt.classList.remove('selected'));
                element.classList.add('selected');
                window.selectedPurchaseMode = mode;
            };

            // Set default payment mode
            window.selectedPurchaseMode = 'Cash';

            document.getElementById('purchase-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemName = document.getElementById('purchase-item').value.trim();
                const quantity = parseInt(document.getElementById('purchase-quantity').value);
                const costPrice = parseFloat(document.getElementById('purchase-cost').value);
                
                let supplierId = null;
                let supplierName = null;

                const supplierSelect = document.getElementById('purchase-supplier-id');
                supplierId = parseInt(supplierSelect.value);
                if (supplierId && !isNaN(supplierId)) {
                    const supplier = (state.suppliers || []).find(s => s.id === supplierId);
                    supplierName = supplier ? supplier.name : 'Unknown Supplier';
                }

                if (!itemName) {
                    showToast('Item Name cannot be empty.');
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    showToast('Quantity must be a valid number greater than 0.');
                    return;
                }
                if (isNaN(costPrice) || costPrice <= 0) {
                    showToast('Cost Price must be a valid number greater than 0.');
                    return;
                }

                // Validate supplier for Udhaar purchases
                if (window.selectedPurchaseMode === 'Udhaar' && !supplierId) {
                    showToast('Supplier is required for Udhaar purchases');
                    return;
                }

                // Add to inventory if it doesn't exist
                const existingItem = (state.inventory || []).find(i => i.name.toLowerCase() === itemName.toLowerCase());
                
                if (!existingItem) {
                    await DB.add('inventory', {
                        name: itemName,
                        cost: costPrice,
                        sellingPrice: parseFloat((costPrice * 1.3).toFixed(2)), // 30% markup
                        createdAt: new Date().toISOString()
                    });
                }

                // Add purchase record
                const purchase = {
                    itemName,
                    quantity,
                    costPrice,
                    total: quantity * costPrice,
                    paymentMode: window.selectedPurchaseMode,
                    supplierId,
                    supplierName: supplierName || 'Not specified',
                    date: new Date().toISOString()
                };

                await DB.add('purchases', purchase);

                // Update supplier balance for Udhaar purchases
                if (window.selectedPurchaseMode === 'Udhaar' && supplierId) {
                    let supplierBalance = state.supplierBalances.find(b => b.supplierId === supplierId);
                    if (supplierBalance) {
                        supplierBalance.balance = (supplierBalance.balance || 0) + purchase.total;
                        await DB.update('supplierBalances', supplierBalance);
                    } else {
                        await DB.add('supplierBalances', {
                            supplierId,
                            supplierName,
                            balance: purchase.total,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    
                    // Record supplier udhaar transaction
                    await DB.add('supplierUdhaarTransactions', {
                        supplierId,
                        amount: purchase.total,
                        type: 'udhaar',
                        note: `Purchase: ${itemName} Ã— ${quantity}`,
                        date: new Date().toISOString()
                    });
                }

                await loadData();
                closeModal();
                showToast('Purchase added successfully!');
                changePage('purchases');
            });
        }
        
        function filterPurchases() {
            const search = document.getElementById('purchase-search').value.toLowerCase();
            const filtered = (state.purchases || []).filter(p => 
                p.itemName.toLowerCase().includes(search) || 
                (p.supplierName && p.supplierName.toLowerCase().includes(search))
            ).slice().reverse();

            document.getElementById('purchase-list').innerHTML = filtered.map(purchase => `
                <div class="card">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold">${purchase.itemName}</div>
                            <div class="text-sm text-gray-600">
                                Qty: ${purchase.quantity} Ã— Cost: ${state.settings.currency}${purchase.costPrice.toFixed(2)} = Total: ${state.settings.currency}${purchase.total.toFixed(2)}
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="badge badge-${purchase.paymentMode.toLowerCase()}">${purchase.paymentMode}</span>
                                ${purchase.supplierName ? `<span class="text-xs text-gray-700 ml-1">Supplier: ${purchase.supplierName}</span>` : ''}
                                <span class="text-xs text-gray-500">${new Date(purchase.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Udhaar Functions - FIXED (No amount limit)
        function showUdhaarPayment(customerId) {
            const customer = (state.customers || []).find(c => c.id === customerId);
            if (!customer) return;
            const currentUdhaar = customer.udhaar || 0;

            createModal('Record Udhaar Payment', `
                <form id="udhaar-payment-form" class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded">
                        <div class="font-semibold">${customer.name}</div>
                        <div class="text-sm text-gray-600">Current Udhaar: <span class="text-red-600 font-bold">${state.settings.currency}${currentUdhaar.toFixed(2)}</span></div>
                    </div>
                    <input type="number" step="0.01" id="payment-amount" placeholder="Payment Amount" class="input" required>
                    <textarea id="payment-note" placeholder="Note (optional)" class="input" rows="2"></textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Record Payment</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('udhaar-payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const note = document.getElementById('payment-note').value;

                if (isNaN(amount) || amount <= 0) {
                    showToast('Payment amount must be a valid number greater than 0.');
                    return;
                }

                // No limit check - allow any positive amount
                customer.udhaar = Math.max(0, currentUdhaar - amount);
                await DB.update('customers', customer);

                await DB.add('udhaarTransactions', {
                    customerId: customer.id,
                    amount,
                    type: 'payment',
                    note: note || 'Payment received',
                    date: new Date().toISOString()
                });

                await loadData();
                closeModal();
                changePage('udhaar');
                showToast('Payment recorded successfully!');
            });
        }

        // Supplier Udhaar Payment Function - FIXED
        function showSupplierUdhaarPayment(supplierId) {
            const supplier = (state.suppliers || []).find(s => s.id === supplierId);
            if (!supplier) return;
            
            const supplierBalance = state.supplierBalances.find(b => b.supplierId === supplierId);
            const currentBalance = supplierBalance ? supplierBalance.balance : 0;

            createModal('Record Supplier Udhaar Payment', `
                <form id="supplier-udhaar-payment-form" class="space-y-4">
                    <div class="bg-gray-100 p-3 rounded">
                        <div class="font-semibold">${supplier.name}</div>
                        <div class="text-sm text-gray-600">Current Udhaar Balance: <span class="text-yellow-700 font-bold">${state.settings.currency}${currentBalance.toFixed(2)}</span></div>
                    </div>
                    <input type="number" step="0.01" id="supplier-payment-amount" placeholder="Payment Amount" class="input" required>
                    <textarea id="supplier-payment-note" placeholder="Note (optional)" class="input" rows="2"></textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="btn bg-yellow-600 text-white flex-1">Record Payment</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('supplier-udhaar-payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('supplier-payment-amount').value);
                const note = document.getElementById('supplier-payment-note').value;

                if (isNaN(amount) || amount <= 0) {
                    showToast('Payment amount must be a valid number greater than 0.');
                    return;
                }

                if (amount > currentBalance) {
                    showToast(`Payment amount cannot exceed current balance of ${state.settings.currency}${currentBalance.toFixed(2)}`);
                    return;
                }

                // Update supplier balance
                if (supplierBalance) {
                    supplierBalance.balance = Math.max(0, currentBalance - amount);
                    supplierBalance.lastUpdated = new Date().toISOString();
                    await DB.update('supplierBalances', supplierBalance);
                }

                // Record supplier payment transaction
                await DB.add('supplierUdhaarTransactions', {
                    supplierId: supplier.id,
                    amount,
                    type: 'payment',
                    note: note || 'Payment made to supplier',
                    date: new Date().toISOString()
                });

                await loadData();
                closeModal();
                changePage('udhaar');
                showToast('Supplier payment recorded successfully!');
            });
        }

        // Offer Functions
        function showAddOffer() {
            const modal = createModal('Create Offer', `
                <form id="offer-form" class="space-y-4">
                    <input type="text" id="offer-title" placeholder="Offer Title (e.g. Buy 5 Get 1 Free)" class="input" required>
                    <select id="offer-target" class="input" required>
                        <option value="">Select Target Item</option>
                        ${(state.inventory || []).map(item => `<option value="${item.name}">${item.name}</option>`).join('')}
                    </select>
                    <input type="number" id="offer-quantity" placeholder="Target Quantity" min="1" value="5" class="input" required>
                    <select id="offer-reward" class="input" required>
                        <option value="">Select Reward Item</option>
                        ${(state.inventory || []).map(item => `<option value="${item.name}">${item.name}</option>`).join('')}
                    </select>
                    <input type="date" id="offer-start" class="input" required>
                    <input type="date" id="offer-end" class="input" required>
                    <div class="text-sm text-gray-600">Terms: No Due Allowed (Hardcoded for simplicity)</div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Create</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('offer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const targetQuantity = parseInt(document.getElementById('offer-quantity').value);
                const startDate = document.getElementById('offer-start').value;
                const endDate = document.getElementById('offer-end').value;

                if (isNaN(targetQuantity) || targetQuantity < 1) {
                    showToast('Target Quantity must be 1 or greater.');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showToast('Start date cannot be after end date.');
                    return;
                }

                const offer = {
                    title: document.getElementById('offer-title').value,
                    targetItem: document.getElementById('offer-target').value,
                    targetQuantity: targetQuantity,
                    rewardItem: document.getElementById('offer-reward').value,
                    startDate: startDate,
                    endDate: endDate,
                    terms: 'No Due Allowed',
                    createdAt: new Date().toISOString()
                };

                await DB.add('offers', offer);
                await loadData();
                closeModal();
                changePage('offers');
            });
        }

        async function editOffer(id) {
            const offer = (state.offers || []).find(o => o.id === id);
            if (!offer) return;

            const modal = createModal('Edit Offer', `
                <form id="edit-offer-form" class="space-y-4">
                    <input type="text" id="edit-offer-title" value="${offer.title}" class="input" required>
                    <select id="edit-offer-target" class="input" required>
                        <option value="">Select Target Item</option>
                        ${(state.inventory || []).map(item => `<option value="${item.name}" ${item.name === offer.targetItem ? 'selected' : ''}>${item.name}</option>`).join('')}
                    </select>
                    <input type="number" id="edit-offer-quantity" value="${offer.targetQuantity}" placeholder="Target Quantity" min="1" class="input" required>
                    <select id="edit-offer-reward" class="input" required>
                        <option value="">Select Reward Item</option>
                        ${(state.inventory || []).map(item => `<option value="${item.name}" ${item.name === offer.rewardItem ? 'selected' : ''}>${item.name}</option>`).join('')}
                    </select>
                    <input type="date" id="edit-offer-start" value="${offer.startDate}" class="input" required>
                    <input type="date" id="edit-offer-end" value="${offer.endDate}" class="input" required>
                    <div class="text-sm text-gray-600">Terms: No Due Allowed (Hardcoded for simplicity)</div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1">Update</button>
                        <button type="button" onclick="closeModal()" class="btn bg-gray-400 text-white flex-1">Cancel</button>
                    </div>
                </form>
            `);

            document.getElementById('edit-offer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const targetQuantity = parseInt(document.getElementById('edit-offer-quantity').value);
                const startDate = document.getElementById('edit-offer-start').value;
                const endDate = document.getElementById('edit-offer-end').value;

                if (isNaN(targetQuantity) || targetQuantity < 1) {
                    showToast('Target Quantity must be 1 or greater.');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showToast('Start date cannot be after end date.');
                    return;
                }

                const updatedOffer = {
                    id: offer.id,
                    title: document.getElementById('edit-offer-title').value,
                    targetItem: document.getElementById('edit-offer-target').value,
                    targetQuantity: targetQuantity,
                    rewardItem: document.getElementById('edit-offer-reward').value,
                    startDate: startDate,
                    endDate: endDate,
                    terms: 'No Due Allowed',
                    createdAt: offer.createdAt
                };

                await DB.update('offers', updatedOffer);
                await loadData();
                closeModal();
                changePage('offers');
            });
        }

        async function deleteOffer(id) {
            const offer = (state.offers || []).find(o => o.id === id);
            if (!offer) return;

            if (!confirm(`Are you sure you want to delete the offer: ${offer.title}?`)) return;
            
            await DB.delete('offers', id);
            await loadData();
            changePage('offers');
        }

        async function grantReward(offerId, customerId) {
            const offer = (state.offers || []).find(o => o.id === offerId);
            const customer = (state.customers || []).find(c => c.id === customerId);

            if (!offer || !customer) return;

            if ((customer.udhaar || 0) > 0) {
                showToast('Customer has pending due (' + state.settings.currency + customer.udhaar.toFixed(2) + '). Cannot grant reward.');
                return;
            }

            if (!confirm(`Grant reward '${offer.rewardItem}' to ${customer.name}? This will reset their progress by ${offer.targetQuantity}.`)) return;

            await DB.add('rewards', {
                offerId,
                customerId,
                offerTitle: offer.title,
                customerName: customer.name,
                rewardItem: offer.rewardItem,
                grantedAt: new Date().toISOString()
            });

            const progress = (state.offerProgress || []).find(p => p.customerId === customerId && p.offerId === offerId);
            if (progress) {
                progress.currentCount = Math.max(0, progress.currentCount - offer.targetQuantity);
                await DB.update('offerProgress', progress);
            }

            await loadData();
            showToast('Reward granted successfully!');
            changePage('offers');
        }

        function viewOfferRewards(offerId) {
            const offerRewards = (state.rewards || []).filter(r => r.offerId === offerId);
            const offer = (state.offers || []).find(o => o.id === offerId);
            if (!offer) return;
            
            const rewardsByCustomer = {};
            offerRewards.forEach(r => {
                if (!rewardsByCustomer[r.customerId]) {
                    rewardsByCustomer[r.customerId] = {
                        name: r.customerName,
                        count: 0,
                        rewards: []
                    };
                }
                rewardsByCustomer[r.customerId].count++;
                rewardsByCustomer[r.customerId].rewards.push(r);
            });

            createModal(`Rewards Granted for: ${offer.title}`, `
                <div class="space-y-2">
                    ${Object.values(rewardsByCustomer).map(customer => `
                        <div class="border-b pb-2">
                            <div class="font-semibold">${customer.name}</div>
                            <div class="text-sm text-gray-600">
                                **${customer.rewards[0].rewardItem}** ${customer.count > 1 ? `(Ã—${customer.count})` : ''}
                            </div>
                            <div class="text-xs text-gray-500">
                                Last Granted: ${new Date(customer.rewards[0].grantedAt).toLocaleString()}
                            </div>
                        </div>
                    `).join('')}
                    ${offerRewards.length === 0 ? '<div class="text-center text-gray-500">No rewards granted yet</div>' : ''}
                </div>
                <button onclick="closeModal()" class="btn bg-gray-600 text-white w-full mt-4">Close</button>
            `);
        }

        function shareDayEndReport() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = (state.sales || []).filter(s => s.date.startsWith(today));
            const todayRevenue = todaySales.reduce((sum, s) => sum + s.total, 0);
            const customerCount = [...new Set(todaySales.map(s => s.customerId))].length;

            const message = `*${state.settings.businessName} - Day End Report*\n\n*Date:* ${new Date().toLocaleDateString()}\n*Total Sales:* ${todaySales.length}\n*Total Revenue:* ${state.settings.currency}${todayRevenue.toFixed(2)}\n*Customers Served:* ${customerCount}\n\n*Great work today!* ðŸŽ‰`;
            
            // For demo, we'll just show the message
            createModal('Day End Report', `
                <div class="space-y-4">
                    <div class="text-center">
                        <h3 class="text-xl font-bold">Day End Report</h3>
                        <div class="text-sm text-gray-600">${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Total Sales:</span>
                            <span class="font-semibold">${todaySales.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Revenue:</span>
                            <span class="font-semibold">${state.settings.currency}${todayRevenue.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Customers Served:</span>
                            <span class="font-semibold">${customerCount}</span>
                        </div>
                    </div>
                    <div class="text-center text-sm text-gray-500 mt-4">
                        Great work today! ðŸŽ‰
                    </div>
                    <button onclick="closeModal()" class="btn bg-gray-600 text-white w-full">Close</button>
                </div>
            `);
        }

        // Modal Helper
        function createModal(title, content) {
            const existingModal = document.getElementById('modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            return modal;
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.remove();
        }

        // Event Listeners
        function attachMainListeners() {
            if (state.currentPage === 'sales') {
                updateCart();
                updatePaymentModeUI();
            } else if (state.currentPage === 'customers' && document.getElementById('customer-search')) {
                filterCustomers();
            } else if (state.currentPage === 'purchases' && document.getElementById('purchase-search')) {
                filterPurchases();
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>